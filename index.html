<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§è´¢ä¸»</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&amp;display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <!-- Tailwind é…ç½® -->
    <script>
        // åŠ¨æ€é’±å¸é›¨æ•ˆæœ
        function createMoneyRain() {
            const moneyRainContainer = document.getElementById('moneyRain');
            const moneySymbols = ['ğŸ˜Š','ğŸ’','ğŸ’–',  'ğŸ’°','ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³'];
            
            function createMoney() {
                const money = document.createElement('div');
                const symbol = moneySymbols[Math.floor(Math.random() * moneySymbols.length)];
                
                money.innerHTML = symbol;
                money.className = 'absolute text-2xl opacity-30';
                money.style.left = Math.random() * 100 + '%';
                money.style.top = '-50px';
                money.style.fontSize = Math.random() * 20 + 16 + 'px';
                money.style.animation = `falling ${Math.random() * 5 + 3}s linear infinite`;
                money.style.animationDelay = Math.random() * 2 + 's';
                money.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                moneyRainContainer.appendChild(money);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                money.addEventListener('animationend', () => {
                    money.remove();
                });
            }
            
            // æ·»åŠ ä¸‹è½åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes falling {
                    0% {
                        transform: translateY(-50px) rotate(0deg);
                        opacity: 0.3;
                    }
                    10% {
                        opacity: 0.8;
                    }
                    90% {
                        opacity: 0.8;
                    }
                    100% {
                        transform: translateY(100vh) rotate(360deg);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // å®šæœŸåˆ›å»ºé’±å¸
            setInterval(createMoney, 500);
            
            // åˆå§‹åˆ›å»ºä¸€äº›é’±å¸
            for (let i = 0; i < 10; i++) {
                setTimeout(createMoney, i * 200);
            }
        }
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00F5FF', // éœ“è™¹è“
                        secondary: '#8A2BE2', // ç´«è‰²
                        income: '#52C41A',
                        expense: '#FF4D4F',
                        dark: {
                            100: '#FEE2E2',
                            200: '#FECACA',
                            300: '#EF4444'
                        },
                        neutral: {
                            100: '#F5F5F5',
                            200: '#E0E0E0',
                            300: '#9E9E9E'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-in-out',
                        'slide-down': 'slideDown 0.3s ease-in-out',
                        'bounce-slow': 'bounceSlow 2s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        bounceSlow: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }
            .glass-dark {
                background: rgba(15, 23, 42, 0.8);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .card-hover {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .card-hover:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #8A2BE2 0%, #20B2AA 100%);
            }
            .gradient-text {
                background: linear-gradient(135deg, #8A2BE2 0%, #20B2AA 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            .btn-primary {
                background: linear-gradient(135deg, #8A2BE2 0%, #20B2AA 100%);
                color: white;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(138, 43, 226, 0.4);
            }
            .btn-primary:active {
                transform: translateY(0);
            }
            .btn-primary::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s;
            }
            .btn-primary:hover::before {
                left: 100%;
            }
            .input-focus {
                transition: all 0.3s ease;
            }
            .input-focus:focus {
                border-color: #8A2BE2;
                box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.1);
            }
            .animate-fade-in-up {
                animation: fadeInUp 0.5s ease-out;
            }
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .animate-scale-in {
                animation: scaleIn 0.3s ease-out;
            }
            @keyframes scaleIn {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            .progress-bar {
                transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
    </style>
    <style>
        /* å…¨å±€éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: transparent;
        }
        
        /* æ•°å­—é”®ç›˜æ ·å¼ */
        .number-keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .number-key {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            border-radius: 50%;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .number-key:hover {
            background-color: #e0e0e0;
            transform: scale(1.05);
        }
        
        /* åˆ†ç±»é€‰æ‹©å™¨æ ·å¼ */
        .category-scroll {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .category-scroll::-webkit-scrollbar {
            display: none;
        }
        .category-item {
            transition: all 0.2s ease;
        }
        .category-item:hover {
            transform: scale(1.1);
        }
        .category-item.active {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            animation: breathing 2s ease-in-out infinite;
        }
        @keyframes breathing {
            0%, 100% {
                transform: scale(1.15);
            }
            50% {
                transform: scale(1.2);
            }
        }
        .category-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: currentColor;
            border-radius: 50%;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        .page-transition {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .page-enter {
            opacity: 0;
            transform: translateX(20px);
        }
        .page-enter-active {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* æ—¥å†æ ·å¼ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            background-color: #f0f0f0;
        }
        .calendar-day.active {
            background-color: #8A2BE2;
            color: white;
        }
    </style>
</head>
<body class="font-sans text-gray-800 min-h-screen relative bg-dark-300">
    <!-- å¯†ç é”æ¨¡æ€æ¡† -->
    <div id="passwordModal" class="fixed inset-0 z-[100] flex items-center justify-center" style="background: linear-gradient(135deg, #c21818 0%, #a01414 50%, #851414 100%);">
        <div class="bg-white rounded-xl p-8 w-11/12 max-w-md animate-fade-in-up glass" style="background-image: url('https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/6ff859d836b341e3bb48bb43bd625ed3.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&rcl=20260117215230DB7748423FD12A7B3DBB&rrcfp=8a172a1a&x-expires=1769262751&x-signature=Xw94Qv5%2Bxy216OrVCknFoBDXmNo%3D'); background-size: cover; background-position: center;">
            <div class="space-y-4 mb-6">
                <div>
                    <input type="password" id="passwordInput" class="w-full border-2 border-yellow-500 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent bg-white/90 text-gray-800 placeholder-gray-600" placeholder="è¯·è¾“å…¥6ä½æ•°å­—å¯†ç ">
                </div>
                
                <div class="text-center text-red-500 text-sm hidden" id="passwordError">
                    å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•
                </div>
            </div>
            
            <div class="text-center">
                <div id="wangsymbol" class="text-4xl cursor-pointer hover:scale-110 transition-transform" style="font-family: 'Ma Shan Zheng', 'STKaiti', 'KaiTi', cursive; color: #D4AF37; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">æ—º</div>
            </div>
        </div>
    </div>
    <!-- å–œåº†çº¢èƒŒæ™¯ -->
    <div class="fixed inset-0 -z-10 bg-dark-300"></div>
    
    <!-- æ—ºå­—èƒŒæ™¯å›¾æ¡ˆ -->
    <div class="fixed inset-0 -z-5 opacity-66 pointer-events-none">
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="font-bold transform rotate-[-5deg]" style="font-family: 'Ma Shan Zheng', 'STKaiti', 'KaiTi', cursive; font-size: min(80vw, 400px); color: #D4AF37; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">æ—º</div>
        </div>
        <!-- å‘¨å›´çš„å°æ–‡å­—è£…é¥° -->
        <div class="absolute top-[10%] left-[10%] text-yellow-400 transform rotate-[-15deg]" style="font-size: min(6vw, 2rem);">ç¦</div>
        <div class="absolute top-[15%] right-[15%] text-yellow-400 transform rotate-[20deg]" style="font-size: min(6vw, 2rem);">è´¢</div>
        <div class="absolute bottom-[20%] left-[15%] text-yellow-400 transform rotate-[10deg]" style="font-size: min(6vw, 2rem);">å‰</div>
        <div class="absolute bottom-[15%] right-[10%] text-yellow-400 transform rotate-[-25deg]" style="font-size: min(6vw, 2rem);">ç¥¥</div>
        <div class="absolute top-[30%] left-[5%] text-yellow-300 transform rotate-[30deg]" style="font-size: min(4vw, 1.5rem);">å¯Œ</div>
        <div class="absolute top-[40%] right-[5%] text-yellow-300 transform rotate-[-10deg]" style="font-size: min(4vw, 1.5rem);">è´µ</div>
        <div class="absolute bottom-[10%] left-[25%] text-yellow-300 transform rotate-[-30deg]" style="font-size: min(4vw, 1.5rem);">ç¦„</div>
        <div class="absolute bottom-[30%] right-[20%] text-yellow-300 transform rotate-[15deg]" style="font-size: min(4vw, 1.5rem);">å¯¿</div>
        <div class="absolute top-[60%] left-[20%] text-yellow-200 transform rotate-[25deg]" style="font-size: min(3vw, 1.25rem);">å–œ</div>
        <div class="absolute top-[20%] right-[25%] text-yellow-200 transform rotate-[-20deg]" style="font-size: min(3vw, 1.25rem);">ç™¼</div>
        <div class="absolute bottom-[40%] left-[10%] text-yellow-200 transform rotate-[5deg]" style="font-size: min(3vw, 1.25rem);">é¡º</div>
        <div class="absolute bottom-[20%] right-[30%] text-yellow-200 transform rotate-[-15deg]" style="font-size: min(3vw, 1.25rem);">å…´</div>
    </div>

    
    <!-- åŠ¨æ€é’±å¸é›¨èƒŒæ™¯ -->
    <div id="moneyRain" class="fixed inset-0 -z-5 pointer-events-none overflow-hidden"></div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container mx-auto px-4 pt-16 pb-20">

        <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
        <div id="dashboardPage" class="page active">
            <!-- æ¬¢è¿å¡ç‰‡ -->
            <div class="rounded-2xl p-6 text-gray-800 mb-6 animate-fade-in-up overflow-hidden relative">
                <!-- äº”ç¦ä¸´é—¨èƒŒæ™¯å›¾ç‰‡ -->
                <div class="absolute inset-0 z-0">
                    <img src="https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/7e96cddec8ca4c03aee5cb2103c38dc4.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&rcl=20260126190624943818D064120F143726&rrcfp=8a172a1a&x-expires=1770030384&x-signature=UbqI76WWnoHIFSj8p9JvzrQqzWI%3D" alt="äº”ç¦ä¸´é—¨" class="w-full h-full object-cover">
                </div>
                <!-- åŠé€æ˜é®ç½© -->
                <div class="absolute inset-0 bg-black/20 z-10"></div>
                <div class="flex justify-between items-center relative z-20">
                    <div>
                        <h2 class="text-base sm:text-lg font-bold text-yellow-300 text-shadow-lg cursor-pointer hover:text-yellow-200 transition-colors" id="helloUserBtn">ä½ å¥½ï¼Œå¤§è´¢ä¸»</h2>
                        <p class="opacity-90 text-white text-shadow text-xs sm:text-sm">ä»Šå¤©æ˜¯ <span id="currentDate"></span></p>
                    </div>
                    <div class="text-xl sm:text-2xl cursor-pointer hover:scale-110 transition-transform text-yellow-300" id="statsIconBtn">
                        <i class="fa fa-line-chart"></i>
                    </div>
                </div>
            </div>

            <!-- è´¢åŠ¡æ¦‚è§ˆå¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-dark-200/50 border border-white/10 rounded-xl p-5 glass card-hover animate-fade-in-up" style="animation-delay: 0.1s; background-image: url('https://p26-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/ea5852e616734375a4f58deb4bbc5659.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&rcl=20260117220954612832D9AAF2F67A99B9&rrcfp=8a172a1a&x-expires=1769263794&x-signature=9EcJy2%2B3QW33se8aGpt4pPfKk6Q%3D'); background-size: cover; background-position: center;">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800/90">æœ¬æœˆæ”¶å…¥</h3>
                        <div class="w-10 h-10 flex items-center justify-center text-yellow-500">
                            <i class="fa fa-arrow-down" aria-hidden="true"></i>
                        </div>
                    </div>
                    <p class="text-2xl sm:text-3xl font-bold text-income" id="monthlyIncome">Â¥0</p>
                </div>
                <div class="bg-dark-200/50 border border-white/10 rounded-xl p-5 glass card-hover animate-fade-in-up" style="animation-delay: 0.2s; background-image: url('https://p26-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/df1654e408b448d1bfa0e23471eaee63.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&rcl=20260117223327F5F3FF6D46EAA37D5091&rrcfp=8a172a1a&x-expires=1769265208&x-signature=dG4jluwmjuh4mlxaqdnJE9gsM%2Fk%3D'); background-size: cover; background-position: center;">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800/90">æœ¬æœˆæ”¯å‡º</h3>
                        <div class="w-10 h-10 flex items-center justify-center text-red-500">
                            <i class="fa fa-arrow-up" aria-hidden="true"></i>
                        </div>
                    </div>
                    <p class="text-2xl sm:text-3xl font-bold text-expense" id="monthlyExpense">Â¥0</p>
                </div>
                <div class="bg-dark-200/50 border border-white/10 rounded-xl p-5 glass card-hover animate-fade-in-up" style="animation-delay: 0.3s; background-image: url('https://p26-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/a22606273d5a49ce9784f9bba60ce36f.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&rcl=202601172240561FA8B253723A9A3061A0&rrcfp=8a172a1a&x-expires=1769265656&x-signature=n42hYoLUDZ2zvikfHxaWjrpVPGA%3D'); background-size: cover; background-position: center;">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800/90">æœ¬æœˆç»“ä½™</h3>
                        <i class="fa fa-balance-scale text-primary text-lg sm:text-xl"></i>
                    </div>
                    <p class="text-2xl sm:text-3xl font-bold text-primary" id="monthlyBalance">Â¥0</p>
                </div>
            </div>

            <!-- é¢„ç®—è¿›åº¦å¡ç‰‡ -->
            <div class="bg-white rounded-xl p-5 glass card-hover mb-6 animate-fade-in-up" style="animation-delay: 0.4s">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-700">æœ¬æœˆé¢„ç®—</h3>
                    <button id="setBudgetBtn" class="text-primary hover:text-opacity-80 transition-colors text-sm">
                        <i class="fa fa-pencil mr-1"></i> è®¾ç½®
                    </button>
                </div>
                <div class="mb-2 flex justify-between text-sm">
                    <span>å·²ä½¿ç”¨</span>
                    <span id="budgetUsedText">Â¥0 / Â¥0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                    <div id="budgetProgressBar" class="bg-primary h-4 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span id="budgetDaysLeft">å‰©ä½™ 30 å¤©</span>
                    <span id="budgetPercentage">0%</span>
                </div>
            </div>

            <!-- æœ€è¿‘äº¤æ˜“ -->
            <div class="bg-white rounded-xl p-5 glass card-hover mb-20 animate-fade-in-up" style="animation-delay: 0.5s">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-700">æœ€è¿‘äº¤æ˜“</h3>
                    <button id="viewAllTransactionsBtn" class="text-primary hover:text-opacity-80 transition-colors text-sm">
                        æŸ¥çœ‹å…¨éƒ¨ <i class="fa fa-angle-right ml-1"></i>
                    </button>
                </div>
                <div id="recentTransactionsList" class="space-y-4">
                    <!-- æœ€è¿‘äº¤æ˜“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div class="text-center text-gray-500 py-4">
                        æš‚æ— äº¤æ˜“è®°å½•
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨è®°è´¦æŒ‰é’® - å·²éšè—ï¼ŒåŠŸèƒ½å·²æ•´åˆåˆ°"ä½ å¥½ï¼Œå¤§è´¢ä¸»"æ–‡å­—ç‚¹å‡» -->
    <!-- <div class="fixed bottom-6 left-0 right-0 flex justify-center z-20">
        <button id="addTransactionBtn" class="bg-transparent border-0 px-2 py-1 flex items-center justify-center transition-all hover:scale-105">
            <span class="text-lg font-bold bg-red-500 px-3 py-1 rounded-lg animate-pulse" style="font-family: 'Ma Shan Zheng', 'STKaiti', 'KaiTi', cursive; font-weight: bold; border-radius: 50%; padding: 8px 12px; color: #D4AF37; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">æ—º</span>
        </button>
    </div> -->



    <!-- æ¨¡æ€æ¡† -->
    <div id="modalContainer" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
        <div id="confirmDeleteModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-md animate-slide-up hidden">
            <div class="text-center mb-6">
                <div class="text-4xl text-expense mb-4">
                    <i class="fa fa-exclamation-triangle"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">ç¡®è®¤åˆ é™¤</h3>
                <p class="text-gray-600">ç¡®å®šè¦åˆ é™¤è¿™æ¡äº¤æ˜“è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            </div>
            <div class="flex space-x-4">
                <button id="cancelDeleteBtn" class="flex-1 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">å–æ¶ˆ</button>
                <button id="confirmDeleteBtn" class="flex-1 py-3 bg-expense text-white rounded-lg hover:bg-expense/90 transition-colors">åˆ é™¤</button>
            </div>
        </div>
        <!-- è®°è´¦æ¨¡æ€æ¡† -->
        <div id="addTransactionModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-md animate-slide-up hidden max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">æ·»åŠ è®°å½•</h3>
                <button class="close-modal text-gray-600 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <!-- äº¤æ˜“ç±»å‹é€‰æ‹© -->
            <div class="mb-8">
                <div class="grid grid-cols-2 gap-4">
                    <button id="incomeTypeBtn" class="bg-income text-gray-800 rounded-xl p-4 flex flex-col items-center justify-center shadow-md hover:shadow-lg transition-all hover:scale-105">
                        <i class="fa fa-plus-circle text-2xl mb-1"></i>
                        <span class="font-medium text-sm">è®°æ”¶å…¥</span>
                    </button>
                    <button id="expenseTypeBtn" class="bg-expense text-gray-800 rounded-xl p-4 flex flex-col items-center justify-center shadow-md hover:shadow-lg transition-all hover:scale-105">
                        <i class="fa fa-minus-circle text-2xl mb-1"></i>
                        <span class="font-medium text-sm">è®°æ”¯å‡º</span>
                    </button>
                </div>
            </div>

            <!-- é‡‘é¢è¾“å…¥ -->
            <div class="mb-8">
                <label class="block text-gray-600 mb-2">é‡‘é¢</label>
                <div class="relative">
                    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl">Â¥</span>
                    <input type="tel" id="amountInput" class="w-full border-0 border-b-2 border-gray-300 focus:border-primary focus:ring-0 text-3xl font-bold py-2 pl-10 pr-4" placeholder="0.00" inputmode="decimal">
                </div>
            </div>

            <!-- åˆ†ç±»é€‰æ‹© -->
            <div class="mb-8">
                <label class="block text-gray-600 mb-4">åˆ†ç±»</label>
                <div id="categoryContainer" class="category-scroll">
                    <div id="expenseCategories" class="flex space-x-4 pb-2">
                        <!-- æ”¯å‡ºåˆ†ç±»å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div id="incomeCategories" class="flex space-x-4 pb-2 hidden">
                        <!-- æ”¶å…¥åˆ†ç±»å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æ—¥æœŸé€‰æ‹© -->
            <div class="mb-8">
                <label class="block text-gray-600 mb-2">æ—¥æœŸ</label>
                <button id="dateSelectorBtn" class="w-full flex justify-between items-center py-3 border-b border-gray-200">
                    <span id="selectedDateText"></span>
                    <i class="fa fa-calendar text-gray-400"></i>
                </button>
                
                <!-- æ—¥å†å¼¹å‡ºå±‚ -->
                <div id="calendarContainer" class="hidden mt-4 bg-white rounded-xl shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonthBtn" class="text-gray-600 hover:text-primary transition-colors">
                            <i class="fa fa-chevron-left"></i>
                        </button>
                        <h3 id="calendarMonthYear" class="font-medium"></h3>
                        <button id="nextMonthBtn" class="text-gray-600 hover:text-primary transition-colors">
                            <i class="fa fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid mb-2">
                        <div class="text-center text-xs text-gray-500 font-medium">æ—¥</div>
                        <div class="text-center text-xs text-gray-500 font-medium">ä¸€</div>
                        <div class="text-center text-xs text-gray-500 font-medium">äºŒ</div>
                        <div class="text-center text-xs text-gray-500 font-medium">ä¸‰</div>
                        <div class="text-center text-xs text-gray-500 font-medium">å››</div>
                        <div class="text-center text-xs text-gray-500 font-medium">äº”</div>
                        <div class="text-center text-xs text-gray-500 font-medium">å…­</div>
                    </div>
                    <div id="calendarDays" class="calendar-grid">
                        <!-- æ—¥å†å¤©æ•°å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å¤‡æ³¨è¾“å…¥ -->
            <div class="mb-8">
                <label class="block text-gray-600 mb-2">å¤‡æ³¨</label>
                <textarea id="descriptionInput" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" rows="3" placeholder="æ·»åŠ å¤‡æ³¨..."></textarea>
            </div>

            <!-- æ™ºèƒ½æ¨è -->
            <div id="smartRecommendation" class="mb-8 hidden">
                <div class="flex items-center mb-2">
                    <i class="fa fa-lightbulb-o text-yellow-500 mr-2"></i>
                    <span class="text-gray-600 font-medium">æ™ºèƒ½æ¨è</span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-sm text-gray-700">æ ¹æ®æ‚¨çš„å†å²è®°å½•ï¼Œæˆ‘ä»¬æ¨èåˆ†ç±»ï¼š</p>
                    <div id="recommendedCategories" class="flex space-x-3 mt-2">
                        <!-- æ¨èåˆ†ç±»å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¿å­˜æŒ‰é’® -->
            <button id="saveTransactionBtn" class="w-full bg-gradient-to-r from-primary to-secondary text-gray-800 py-4 rounded-xl font-bold hover:opacity-90 transition-opacity">
                ä¿å­˜è®°å½•
            </button>
        </div>

        <!-- ç»Ÿè®¡æ¨¡æ€æ¡† -->
        <div id="statisticsModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-lg animate-slide-up hidden max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">æ•°æ®ç»Ÿè®¡</h3>
                <button class="close-modal text-gray-800/70 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
            <div class="flex mb-6 bg-gray-100 rounded-full p-1">
                <button class="time-range-btn flex-1 py-2 rounded-full text-center text-sm font-medium transition-all bg-white shadow-sm" data-range="week">æœ¬å‘¨</button>
                <button class="time-range-btn flex-1 py-2 rounded-full text-center text-sm font-medium transition-all" data-range="month">æœ¬æœˆ</button>
                <button class="time-range-btn flex-1 py-2 rounded-full text-center text-sm font-medium transition-all" data-range="year">æœ¬å¹´</button>
            </div>

            <!-- æ”¶æ”¯è¶‹åŠ¿å›¾ -->
            <div class="mb-8">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">æ”¶æ”¯è¶‹åŠ¿</h4>
                <div class="bg-white rounded-lg p-2">
                    <canvas id="trendChart" height="200"></canvas>
                </div>
            </div>

            <!-- åˆ†ç±»åˆ†å¸ƒå›¾ -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold text-gray-700">åˆ†ç±»åˆ†å¸ƒ</h4>
                    <div class="flex space-x-2">
                        <button id="expenseDistributionBtn" class="px-3 py-1 text-sm rounded-full bg-expense bg-opacity-10 text-expense font-medium">æ”¯å‡º</button>
                        <button id="incomeDistributionBtn" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-600 font-medium">æ”¶å…¥</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-2">
                    <canvas id="distributionChart" height="250"></canvas>
                </div>
            </div>

            <!-- åˆ†ç±»æ˜ç»† -->
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-4">åˆ†ç±»æ˜ç»†</h4>
                <div id="categoryDetails" class="space-y-4">
                    <!-- åˆ†ç±»æ˜ç»†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å¯¼å‡ºæŒ‰é’® -->
            <div class="mt-6">
                <button id="exportStatsBtn" class="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                    <i class="fa fa-download mr-2"></i> å¯¼å‡ºæ•°æ®
                </button>
            </div>
        </div>

        <!-- é¢„ç®—æ¨¡æ€æ¡† -->
        <div id="budgetModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-md animate-slide-up hidden max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">é¢„ç®—ç®¡ç†</h3>
                <button class="close-modal text-gray-800/70 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <!-- å½“å‰é¢„ç®— -->
            <div id="currentBudgetCard" class="mb-8">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">æœ¬æœˆé¢„ç®—</h4>
                <div class="bg-gradient-to-r from-primary to-secondary rounded-xl p-6 text-gray-800">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg">é¢„ç®—é‡‘é¢</span>
                        <span class="text-2xl font-bold" id="currentBudgetAmount">Â¥0</span>
                    </div>
                    <div class="mb-2 flex justify-between text-sm">
                        <span>å·²ä½¿ç”¨</span>
                        <span id="currentBudgetUsedText">Â¥0 / Â¥0</span>
                    </div>
                    <div class="w-full bg-white bg-opacity-30 rounded-full h-4 mb-2">
                        <div id="currentBudgetProgressBar" class="bg-white h-4 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span id="currentBudgetDaysLeft">å‰©ä½™ 30 å¤©</span>
                        <span id="currentBudgetPercentage">0%</span>
                    </div>
                </div>
            </div>

            <!-- è®¾ç½®é¢„ç®— -->
            <div class="mb-8">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">è®¾ç½®é¢„ç®—</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-600 mb-2">é¢„ç®—é‡‘é¢</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-xl">Â¥</span>
                            <input type="number" id="budgetAmountInput" class="w-full border-0 border-b-2 border-gray-300 focus:border-primary focus:ring-0 text-2xl font-bold py-2 pl-10 pr-4" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-2">é¢„ç®—æœˆä»½</label>
                        <input type="month" id="budgetMonthInput" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <button id="saveBudgetBtn" class="w-full bg-gradient-to-r from-primary to-secondary text-gray-800 py-3 rounded-xl font-bold hover:opacity-90 transition-opacity">
                        ä¿å­˜é¢„ç®—
                    </button>
                </div>
            </div>

            <!-- é¢„ç®—å†å² -->
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-4">é¢„ç®—å†å²</h4>
                <div id="budgetHistoryList" class="space-y-4">
                    <!-- é¢„ç®—å†å²å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div class="text-center text-gray-500 py-4">
                        æš‚æ— é¢„ç®—è®°å½•
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬”è®°ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="notesModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-md animate-slide-up hidden max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="notesModalTitle">æ–°å»ºç¬”è®°</h3>
                <button class="close-modal text-gray-800/70 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡é¢˜</label>
                    <input type="text" id="noteTitleInput" class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="è¯·è¾“å…¥ç¬”è®°æ ‡é¢˜...">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å†…å®¹</label>
                    <textarea id="noteContentInput" rows="8" class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none" placeholder="è¯·è¾“å…¥ç¬”è®°å†…å®¹..."></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button id="deleteNoteBtn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition-colors hidden">
                    <i class="fa fa-trash mr-2"></i>åˆ é™¤
                </button>
                <button id="saveNoteBtn" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg transition-colors">
                    <i class="fa fa-save mr-2"></i>ä¿å­˜
                </button>
            </div>
        </div>

        <!-- å¯¼å‡ºæ•°æ®æ¨¡æ€æ¡† -->
        <div id="exportModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-md animate-slide-up hidden max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">å¯¼å‡ºæ•°æ®</h3>
                <button class="close-modal text-gray-800/70 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="mb-6">
                <p class="text-gray-600 mb-4">é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š</p>
                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="exportFormat" value="csv" class="mr-3" checked="">
                        <div>
                            <span class="block font-medium">CSV æ–‡ä»¶</span>
                            <span class="text-sm text-gray-500">å¯åœ¨ Excel ä¸­æ‰“å¼€</span>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="exportFormat" value="json" class="mr-3">
                        <div>
                            <span class="block font-medium">JSON æ–‡ä»¶</span>
                            <span class="text-sm text-gray-500">é€‚åˆå¼€å‘è€…ä½¿ç”¨</span>
                        </div>
                    </label>
                </div>
            </div>
            <div class="mb-6">
                <p class="text-gray-600 mb-4">é€‰æ‹©å¯¼å‡ºèŒƒå›´ï¼š</p>
                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="exportRange" value="all" class="mr-3" checked="">
                        <span>æ‰€æœ‰æ•°æ®</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="exportRange" value="currentMonth" class="mr-3">
                        <span>å½“å‰æœˆä»½</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="exportRange" value="custom" class="mr-3">
                        <span>è‡ªå®šä¹‰èŒƒå›´</span>
                    </label>
                </div>
            </div>
            <div id="customDateRange" class="mb-6 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-600 mb-2">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="exportStartDate" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-2">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="exportEndDate" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
            </div>
            <button id="confirmExportBtn" class="w-full bg-gradient-to-r from-primary to-secondary text-gray-800 py-4 rounded-xl font-bold hover:opacity-90 transition-opacity">
                å¯¼å‡ºæ•°æ®
            </button>
        </div>

        <!-- æ”¶å…¥æ˜ç»†æ¨¡æ€æ¡† -->
        <div id="incomeDetailModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-lg animate-slide-up hidden max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">æœ¬æœˆæ”¶å…¥æ˜ç»†</h3>
                <button class="close-modal text-gray-800/70 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- æ”¶å…¥åˆ†ç±»ç»Ÿè®¡ -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">åˆ†ç±»ç»Ÿè®¡</h4>
                <div class="bg-white rounded-lg p-2">
                    <canvas id="incomeCategoryChart" height="200"></canvas>
                </div>
            </div>
            
            <!-- æ”¶å…¥åˆ—è¡¨ -->
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-4">æ”¶å…¥è®°å½•</h4>
                <div id="incomeDetailList" class="space-y-4">
                    <!-- æ”¶å…¥æ˜ç»†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- æ”¯å‡ºæ˜ç»†æ¨¡æ€æ¡† -->
        <div id="expenseDetailModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-lg animate-slide-up hidden max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">æœ¬æœˆæ”¯å‡ºæ˜ç»†</h3>
                <button class="close-modal text-gray-800/70 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡ -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">åˆ†ç±»ç»Ÿè®¡</h4>
                <div class="bg-white rounded-lg p-2">
                    <canvas id="expenseCategoryChart" height="200"></canvas>
                </div>
            </div>
            
            <!-- æ”¯å‡ºåˆ—è¡¨ -->
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-4">æ”¯å‡ºè®°å½•</h4>
                <div id="expenseDetailList" class="space-y-4">
                    <!-- æ”¯å‡ºæ˜ç»†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <div id="allTransactionsModal" class="bg-dark-200/80 border border-white/10 rounded-xl p-6 w-11/12 max-w-lg animate-slide-up hidden max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">æ‰€æœ‰äº¤æ˜“</h3>
                <button class="close-modal text-gray-800/70 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- æœç´¢å’Œç­›é€‰ -->
            <div class="mb-6 space-y-4">
                <div class="relative">
                    <input type="text" id="transactionSearchInput" class="w-full border border-gray-300 rounded-lg py-3 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="æœç´¢äº¤æ˜“...">
                    <i class="fa fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                
                <!-- æ—¥æœŸèŒƒå›´ç­›é€‰ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDateInput" class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="endDateInput" class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
                
                <button id="filterByDateBtn" class="w-full bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg transition-colors">
                    <i class="fa fa-filter mr-2"></i>æŒ‰æ—¶é—´ç­›é€‰
                </button>
            </div>
            
            <!-- äº¤æ˜“åˆ—è¡¨ -->
            <div id="allTransactionsList" class="max-h-96 overflow-y-auto space-y-4">
                <!-- äº¤æ˜“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div class="text-center text-gray-500 py-4">
                    æš‚æ— äº¤æ˜“è®°å½•
                </div>
            </div>
        </div>
    </div>

<script>
    // æ•°æ®æ¨¡å‹
    var expenseCategories = [
        { id: 'food', name: 'é¤é¥®', icon: 'fa-cutlery', color: '#FF6B6B' },
        { id: 'transport', name: 'äº¤é€š', icon: 'fa-car', color: '#4ECDC4' },
        { id: 'shopping', name: 'è´­ç‰©', icon: 'fa-shopping-bag', color: '#45B7D1' },
        { id: 'entertainment', name: 'å¨±ä¹', icon: 'fa-film', color: '#F7DC6F' },
        { id: 'bills', name: 'è´¦å•', icon: 'fa-file-text-o', color: '#BB8FCE' },
        { id: 'health', name: 'åŒ»ç–—', icon: 'fa-heartbeat', color: '#52C41A' },
        { id: 'education', name: 'æ•™è‚²', icon: 'fa-book', color: '#FA8C16' },
        { id: 'other_expense', name: 'å…¶ä»–', icon: 'fa-ellipsis-h', color: '#95A5A6' }
    ];

    var incomeCategories = [
        { id: 'salary', name: 'å·¥èµ„', icon: 'fa-money', color: '#52C41A' },
        { id: 'bonus', name: 'å¥–é‡‘', icon: 'fa-gift', color: '#FA8C16' },
        { id: 'investment', name: 'æŠ•èµ„', icon: 'fa-line-chart', color: '#1890FF' },
        { id: 'other_income', name: 'å…¶ä»–', icon: 'fa-ellipsis-h', color: '#95A5A6' }
    ];

    // å·¥å…·å‡½æ•°
    var formatCurrency = function(amount) {
        return 'Â¥' + amount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    var formatDate = function(date) {
        var d = new Date(date);
        return d.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
    };

    var formatMonthYear = function(date) {
        var d = new Date(date);
        return d.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' });
    };

    var getMonthRange = function(date) {
        var d = new Date(date);
        var year = d.getFullYear();
        var month = d.getMonth();
        return {
            start: new Date(year, month, 1),
            end: new Date(year, month + 1, 0)
        };
    };

    var getWeekRange = function(date) {
        var d = new Date(date);
        var day = d.getDay();
        var diff = d.getDate() - day + (day === 0 ? -6 : 1); // è°ƒæ•´åˆ°å‘¨ä¸€
        return {
            start: new Date(d.setDate(diff)),
            end: new Date(d.setDate(diff + 6))
        };
    };

    var getYearRange = function(date) {
        var d = new Date(date);
        var year = d.getFullYear();
        return {
            start: new Date(year, 0, 1),
            end: new Date(year, 11, 31)
        };
    };

    var generateId = function() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    };

    // ä½¿ç”¨ IIFE åˆ›å»ºç§æœ‰ä½œç”¨åŸŸï¼Œé¿å…å˜é‡å†²çª
    const DataStorage = (function() {
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://hojyzzpaumhizshocekp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhvanl6enBhdW1oaXpzaG9jZWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MjU2NDUsImV4cCI6MjA4NDIwMTY0NX0.hy8hDHW7R7I4hJ7uA0mvUGBBsprfoUN1FOIaW1HYNHo';
        
        // ç¡®ä¿ supabase SDK å·²åŠ è½½
        if (!window.supabase || !window.supabase.createClient) {
            console.error('Supabase SDK not loaded!');
            return {
                getTransactions: async () => [],
                addTransaction: async () => { throw new Error('Supabase SDK not loaded'); },
                updateTransaction: async () => { throw new Error('Supabase SDK not loaded'); },
                deleteTransaction: async () => { throw new Error('Supabase SDK not loaded'); },
                getBudgets: async () => [],
                addBudget: async () => { throw new Error('Supabase SDK not loaded'); },
                getBudgetForMonth: async () => null,
                getNotes: async () => [],
                addNote: async () => { throw new Error('Supabase SDK not loaded'); },
                updateNote: async () => { throw new Error('Supabase SDK not loaded'); },
                deleteNote: async () => { throw new Error('Supabase SDK not loaded'); },
                subscribeToTransactions: () => () => {}
            };
        }
        
        // ä»å…¨å±€ä½œç”¨åŸŸæ­£ç¡®è·å– createClient
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // å°†Supabaseå®¢æˆ·ç«¯ä¿å­˜åˆ°windowå¯¹è±¡ï¼Œä»¥ä¾¿åœ¨å…¶ä»–åœ°æ–¹è®¿é—®
        window.supabaseClient = supabase;

        // æ•°æ®å­˜å‚¨ç±»çš„å®ç°
        class DataStorage {
        static async getTransactions() {
            const { data, error } = await supabase
                .from('transactions')
                .select('*')
                .order('date', { ascending: false });
            if (error) {
                console.error('Error fetching transactions:', error);
                return null;
            }
            return data;
        }

        static async addTransaction(transaction) {
            const { data, error } = await supabase
                .from('transactions')
                .insert([{...transaction, id: generateId()}])
                .select();
            if (error) {
                console.error('Error adding transaction:', error);
                throw error;
            }
            return data[0];
        }

        static async updateTransaction(id, updates) {
            const { data, error } = await supabase
                .from('transactions')
                .update(updates)
                .eq('id', id)
                .select();
            if (error) {
                console.error('Error updating transaction:', error);
                throw error;
            }
            return data[0];
        }

        static async deleteTransaction(id) {
            const { error } = await supabase
                .from('transactions')
                .delete()
                .eq('id', id);
            if (error) {
                console.error('Error deleting transaction:', error);
                throw error;
            }
        }

        static async getBudgets() {
            const { data, error } = await supabase
                .from('budgets')
                .select('*');
            if (error) {
                console.error('Error fetching budgets:', error);
                return null;
            }
            return data;
        }

        static async addBudget(budget) {
            const { data, error } = await supabase
                .from('budgets')
                .upsert([{...budget, id: budget.id || generateId()}], { onConflict: 'month' })
                .select();
            if (error) {
                console.error('Error saving budget:', error);
                throw error;
            }
            return data[0];
        }

        static async getBudgetForMonth(month) {
            const { data, error } = await supabase
                .from('budgets')
                .select('*')
                .eq('month', month)
                .maybeSingle();
            if (error) {
                if (error.code === 'PGRST116') { // No rows returned
                    return null;
                }
                console.error('Error fetching budget:', error);
                return null;
            }
            return data;
        }

        static subscribeToTransactions(callback) {
            const subscription = supabase
                .channel('public:transactions')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'transactions' },
                    (payload) => {
                        console.log('Transaction change received!', payload);
                        callback(payload);
                    }
                )
                .subscribe();

            return () => subscription.unsubscribe();
        }

        // ç¬”è®°ç›¸å…³æ–¹æ³•
        static async getNotes() {
            const { data, error } = await supabase
                .from('notes')
                .select('*')
                .order('updated_at', { ascending: false });
            if (error) {
                console.error('Error fetching notes:', error);
                return [];
            }
            return data;
        }

        static async addNote(note) {
            const { data, error } = await supabase
                .from('notes')
                .insert([{
                    ...note,
                    id: generateId(),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }])
                .select();
            if (error) {
                console.error('Error adding note:', error);
                throw error;
            }
            return data[0];
        }

        static async updateNote(id, updates) {
            const { data, error } = await supabase
                .from('notes')
                .update({
                    ...updates,
                    updated_at: new Date().toISOString()
                })
                .eq('id', id)
                .select();
            if (error) {
                console.error('Error updating note:', error);
                throw error;
            }
            return data[0];
        }

        static async deleteNote(id) {
            const { error } = await supabase
                .from('notes')
                .delete()
                .eq('id', id);
            if (error) {
                console.error('Error deleting note:', error);
                throw error;
            }
        }
        }

        // è¿”å› DataStorage ç±»
        return DataStorage;
    })();

    // æ™ºèƒ½åˆ†ç±»æ¨è
    class SmartCategoryRecommender {
        static async getRecommendations(description, type) {
            var transactions = await DataStorage.getTransactions() || [];
            var categories = type === 'expense' ? expenseCategories : incomeCategories;
            
            // å¦‚æœæ²¡æœ‰æè¿°ï¼Œè¿”å›ç©º
            if (!description || description.trim() === '') {
                return [];
            }
            
            // æŸ¥æ‰¾åŒ…å«ç›¸ä¼¼æè¿°çš„äº¤æ˜“
            var similarTransactions = transactions.filter(t => 
                t.type === type && 
                t.description && 
                t.description.toLowerCase().includes(description.toLowerCase())
            );
            
            // å¦‚æœæ²¡æœ‰ç›¸ä¼¼äº¤æ˜“ï¼Œè¿”å›ç©º
            if (similarTransactions.length === 0) {
                return [];
            }
            
            // ç»Ÿè®¡åˆ†ç±»å‡ºç°æ¬¡æ•°
            var categoryCounts = {};
            similarTransactions.forEach(t => {
                categoryCounts[t.category] = (categoryCounts[t.category] || 0) + 1;
            });
            
            // æŒ‰å‡ºç°æ¬¡æ•°æ’åº
            var sortedCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([categoryId, count]) => {
                    var category = categories.find(c => c.id === categoryId);
                    return { ...category, count };
                })
                .filter(c => c); // è¿‡æ»¤æ‰å¯èƒ½çš„undefined
            
            // è¿”å›å‰2ä¸ªæ¨è
            return sortedCategories.slice(0, 2);
        }
    }

    // ç»Ÿè®¡åˆ†æ
    class StatisticsAnalyzer {
        static async getMonthlyStats(date) {
            var transactions = await DataStorage.getTransactions() || [];
            var { start, end } = getMonthRange(date);
            
            var monthlyTransactions = transactions.filter(t => {
                var transactionDate = new Date(t.date);
                return transactionDate >= start && transactionDate <= end;
            });
            
            var income = monthlyTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            var expense = monthlyTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            return {
                income,
                expense,
                balance: income - expense,
                transactions: monthlyTransactions
            };
        }

        static getCategoryStats(transactions, type) {
            if (!transactions) return [];
            var categories = type === 'expense' ? expenseCategories : incomeCategories;
            
            var categoryStats = categories.map(category => {
                var amount = transactions
                    .filter(t => t.type === type && t.category === category.id)
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                return {
                    ...category,
                    amount,
                    percentage: 0 // å°†åœ¨ä¸‹ä¸€æ­¥è®¡ç®—
                };
            });
            
            var total = categoryStats.reduce((sum, c) => sum + c.amount, 0);
            
            // è®¡ç®—ç™¾åˆ†æ¯”
            categoryStats.forEach(c => {
                c.percentage = total > 0 ? (c.amount / total) * 100 : 0;
            });
            
            // æŒ‰é‡‘é¢é™åºæ’åº
            return categoryStats.sort((a, b) => b.amount - a.amount);
        }

        static async getTrendData(range, type) {
            var transactions = await DataStorage.getTransactions() || [];
            let { start, end } = {};
            
            switch (range) {
                case 'week':
                    ({ start, end } = getWeekRange(new Date()));
                    break;
                case 'month':
                    ({ start, end } = getMonthRange(new Date()));
                    break;
                case 'year':
                    ({ start, end } = getYearRange(new Date()));
                    break;
                default:
                    ({ start, end } = getMonthRange(new Date()));
            }
            
            // è¿‡æ»¤æ—¥æœŸèŒƒå›´å†…çš„äº¤æ˜“
            var filteredTransactions = transactions.filter(t => {
                var transactionDate = new Date(t.date);
                return transactionDate >= start && transactionDate <= end;
            });
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            var groupedByDate = {};
            
            // åˆå§‹åŒ–æ—¥æœŸèŒƒå›´å†…çš„æ‰€æœ‰æ—¥æœŸ
            var current = new Date(start);
            while (current <= end) {
                var dateKey = current.toISOString().split('T')[0];
                groupedByDate[dateKey] = { income: 0, expense: 0 };
                current.setDate(current.getDate() + 1);
            }
            
            // ç´¯åŠ æ¯ä¸ªæ—¥æœŸçš„æ”¶æ”¯
            filteredTransactions.forEach(t => {
                var dateKey = new Date(t.date).toISOString().split('T')[0];
                if (groupedByDate[dateKey]) {
                    groupedByDate[dateKey][t.type] += t.amount;
                }
            });
            
            // è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®æ ¼å¼
            var labels = Object.keys(groupedByDate).map(date => {
                var d = new Date(date);
                if (range === 'week') {
                    return ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][d.getDay()];
                } else if (range === 'month') {
                    return d.getDate() + 'æ—¥';
                } else {
                    return ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'][d.getMonth()];
                }
            });
            
            var incomeData = Object.values(groupedByDate).map(d => d.income);
            var expenseData = Object.values(groupedByDate).map(d => d.expense);
            
            return {
                labels,
                datasets: [
                    {
                        label: 'æ”¶å…¥',
                        data: incomeData,
                        borderColor: '#52C41A',
                        backgroundColor: 'rgba(82, 196, 26, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'æ”¯å‡º',
                        data: expenseData,
                        borderColor: '#FF4D4F',
                        backgroundColor: 'rgba(255, 77, 79, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            };
        }
    }

    // UI æ§åˆ¶å™¨
    class UIController {
        static async init() {
            this.updateCurrentDate();
            this.setupEventListeners();
            await this.renderDashboard();
            this.renderCategories();
            this.initCharts();
            this.renderBudgetHistory();
            
            // è®¾ç½®å®æ—¶æ•°æ®è®¢é˜…
            this.setupRealtimeSubscriptions();
            
            // å¯åŠ¨åŠ¨æ€é’±å¸é›¨æ•ˆæœ
            createMoneyRain();
        }

        static showModal(modalId) {
            const modalContainer = document.getElementById('modalContainer');
            const targetModal = document.getElementById(modalId);
            
            if (!modalContainer || !targetModal) {
                console.error('æ¨¡æ€æ¡†å®¹å™¨æˆ–ç›®æ ‡æ¨¡æ€æ¡†ä¸å­˜åœ¨');
                return;
            }
            
            modalContainer.classList.remove('hidden');
            modalContainer.querySelectorAll('div[id$="Modal"]').forEach(modal => {
                modal.classList.add('hidden');
            });
            targetModal.classList.remove('hidden');
            
            // å¦‚æœæ˜¯ç»Ÿè®¡æ¨¡æ€æ¡†ï¼Œåˆå§‹åŒ–å›¾è¡¨
            if (modalId === 'statisticsModal' && this.trendChart && this.distributionChart) {
                this.updateStatistics('week');
            }
        }

        static updateCurrentDate() {
            var now = new Date();
            document.getElementById('currentDate').textContent = formatDate(now);
            
            // è®¾ç½®é»˜è®¤é€‰æ‹©çš„æ—¥æœŸä¸ºä»Šå¤©
            var today = now.toISOString().split('T')[0];
            document.getElementById('selectedDateText').textContent = formatDate(now);
            document.getElementById('exportStartDate').value = today;
            document.getElementById('exportEndDate').value = today;
            
            // è®¾ç½®é¢„ç®—æœˆä»½ä¸ºå½“å‰æœˆä»½
            var currentMonth = now.toISOString().substr(0, 7);
            document.getElementById('budgetMonthInput').value = currentMonth;
        }

        static setupRealtimeSubscriptions() {
            // è®¢é˜…äº¤æ˜“æ•°æ®å˜æ›´
            const unsubscribe = DataStorage.subscribeToTransactions((payload) => {
                console.log('å®æ—¶æ•°æ®æ›´æ–°:', payload);
                // æ ¹æ®äº‹ä»¶ç±»å‹æ‰§è¡Œç›¸åº”æ“ä½œ
                switch (payload.eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                    case 'DELETE':
                        // é‡æ–°æ¸²æŸ“ä»ªè¡¨ç›˜ä»¥åæ˜ æœ€æ–°æ•°æ®
                        this.renderDashboard();
                        break;
                }
            });

            // åœ¨é¡µé¢å¸è½½æ—¶å–æ¶ˆè®¢é˜…
            window.addEventListener('beforeunload', unsubscribe);
        }

        static setupEventListeners() {
            // å¯¼èˆªæŒ‰é’® - é¦–é¡µ (å·²ç§»é™¤å¯¼èˆªæ ï¼Œä¿ç•™ä»£ç ä»¥å¤‡å°†æ¥ä½¿ç”¨)
            /*
            const dashboardNavBtn = document.querySelector('.nav-btn[data-page="dashboardPage"]');
            if (dashboardNavBtn) {
                dashboardNavBtn.addEventListener('click', () => {
                    // æ›´æ–°å¯¼èˆªæŒ‰é’®æ ·å¼
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('text-primary');
                        b.classList.add('text-gray-500');
                    });
                    dashboardNavBtn.classList.remove('text-gray-500');
                    dashboardNavBtn.classList.add('text-primary');
                });
            }
            */
            
            // ä½ å¥½ï¼Œå¤§è´¢ä¸» æ–‡å­—ç‚¹å‡»äº‹ä»¶
            const helloUserBtn = document.getElementById('helloUserBtn');
            if (helloUserBtn) {
                helloUserBtn.addEventListener('click', function() {
                    console.log('ä½ å¥½ï¼Œå¤§è´¢ä¸» è¢«ç‚¹å‡»');
                    UIController.showModal('addTransactionModal');
                });
            } else {
                console.error('æ‰¾ä¸åˆ°ä½ å¥½ï¼Œå¤§è´¢ä¸»æŒ‰é’®');
            }
            
            // ç»Ÿè®¡å›¾æ ‡æŒ‰é’®äº‹ä»¶
            const statsIconBtn = document.getElementById('statsIconBtn');
            if (statsIconBtn) {
                statsIconBtn.addEventListener('click', function() {
                    // æ˜¾ç¤ºç»Ÿè®¡æ¨¡æ€æ¡†
                    UIController.showModal('statisticsModal');
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    UIController.updateStatistics('week'); // é»˜è®¤æ˜¾ç¤ºå‘¨ç»Ÿè®¡
                });
            }
            
            // è®¾ç½®é¢„ç®—æŒ‰é’®
            const setBudgetBtn = document.getElementById('setBudgetBtn');
            if (setBudgetBtn) {
                setBudgetBtn.addEventListener('click', () => {
                    this.showModal('budgetModal');
                    this.updateBudgetProgress();
                });
            }

            // è®°äº‹æœ¬ç›¸å…³äº‹ä»¶ç›‘å¬
            // æ–°å»ºç¬”è®°æŒ‰é’®
            const addNoteBtn = document.getElementById('addNoteBtn');
            if (addNoteBtn) {
                addNoteBtn.addEventListener('click', () => {
                    document.getElementById('notesModalTitle').textContent = 'æ–°å»ºç¬”è®°';
                    document.getElementById('noteTitleInput').value = '';
                    document.getElementById('noteContentInput').value = '';
                    document.getElementById('deleteNoteBtn').classList.add('hidden');
                    document.getElementById('deleteNoteBtn').dataset.noteId = '';
                    this.showModal('notesModal');
                });
            }

            // ä¿å­˜ç¬”è®°æŒ‰é’®
            const saveNoteBtn = document.getElementById('saveNoteBtn');
            if (saveNoteBtn) {
                saveNoteBtn.addEventListener('click', () => {
                    const title = document.getElementById('noteTitleInput').value.trim();
                    const content = document.getElementById('noteContentInput').value.trim();
                    const deleteBtn = document.getElementById('deleteNoteBtn');
                    const noteId = deleteBtn.dataset.noteId;

                    if (!title && !content) {
                        this.showToast('è¯·è¾“å…¥ç¬”è®°æ ‡é¢˜æˆ–å†…å®¹', 'error');
                        return;
                    }

                    const noteData = {
                        title: title || 'æ— æ ‡é¢˜',
                        content: content || ''
                    };

                    if (noteId) {
                        // æ›´æ–°ç¬”è®°
                        DataStorage.updateNote(noteId, noteData);
                        this.showToast('ç¬”è®°å·²æ›´æ–°', 'success');
                    } else {
                        // æ–°å»ºç¬”è®°
                        DataStorage.addNote(noteData);
                        this.showToast('ç¬”è®°å·²ä¿å­˜', 'success');
                    }

                    this.renderNotes();
                    this.hideModal('notesModal');
                });
            }

            // åˆ é™¤ç¬”è®°æŒ‰é’®
            const deleteNoteBtn = document.getElementById('deleteNoteBtn');
            if (deleteNoteBtn) {
                deleteNoteBtn.addEventListener('click', () => {
                    const noteId = deleteNoteBtn.dataset.noteId;
                    if (noteId) {
                        this.deleteNote(noteId);
                        this.hideModal('notesModal');
                    }
                });
            }
            
            // æŸ¥çœ‹å…¨éƒ¨äº¤æ˜“æŒ‰é’®
            const viewAllTransactionsBtn = document.getElementById('viewAllTransactionsBtn');
            if (viewAllTransactionsBtn) {
                viewAllTransactionsBtn.addEventListener('click', () => {
                    this.showModal('allTransactionsModal');
                    this.renderAllTransactions();
                });
            }
            
            // æœ¬æœˆæ”¶å…¥å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            const monthlyIncome = document.getElementById('monthlyIncome');
            if (monthlyIncome && monthlyIncome.parentElement) {
                monthlyIncome.parentElement.addEventListener('click', () => {
                    UIController.showIncomeDetailModal();
                });
            }
            
            // æœ¬æœˆæ”¯å‡ºå¡ç‰‡ç‚¹å‡»äº‹ä»¶
            const monthlyExpense = document.getElementById('monthlyExpense');
            if (monthlyExpense && monthlyExpense.parentElement) {
                monthlyExpense.parentElement.addEventListener('click', () => {
                    UIController.showExpenseDetailModal();
                });
            }
            
            // äº¤æ˜“ç±»å‹åˆ‡æ¢
            const incomeTypeBtn = document.getElementById('incomeTypeBtn');
            if (incomeTypeBtn) {
                incomeTypeBtn.addEventListener('click', () => {
                    this.setTransactionType('income');
                });
            }
            
            const expenseTypeBtn = document.getElementById('expenseTypeBtn');
            if (expenseTypeBtn) {
                expenseTypeBtn.addEventListener('click', () => {
                    this.setTransactionType('expense');
                });
            }
            
            // æ—¥æœŸé€‰æ‹©å™¨
            const dateSelectorBtn = document.getElementById('dateSelectorBtn');
            if (dateSelectorBtn) {
                dateSelectorBtn.addEventListener('click', () => {
                    const calendarContainer = document.getElementById('calendarContainer');
                    if (calendarContainer) {
                        calendarContainer.classList.toggle('hidden');
                        if (!calendarContainer.classList.contains('hidden')) {
                            this.renderCalendar();
                        }
                    }
                });
            }
            
            // æ—¥å†å¯¼èˆª
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', () => {
                    this.currentCalendarMonth--;
                    if (this.currentCalendarMonth < 0) {
                        this.currentCalendarMonth = 11;
                        this.currentCalendarYear--;
                    }
                    this.renderCalendar();
                });
            }
            
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', () => {
                    this.currentCalendarMonth++;
                    if (this.currentCalendarMonth > 11) {
                        this.currentCalendarMonth = 0;
                        this.currentCalendarYear++;
                    }
                    this.renderCalendar();
                });
            }
            
            // å¤‡æ³¨è¾“å…¥ç›‘å¬ï¼ˆç”¨äºæ™ºèƒ½æ¨èï¼‰
            const descriptionInput = document.getElementById('descriptionInput');
            if (descriptionInput) {
                descriptionInput.addEventListener('input', (e) => {
                    const description = e.target.value;
                    const type = (incomeTypeBtn && incomeTypeBtn.classList.contains('bg-white')) ? 'income' : 'expense';
                    this.updateSmartRecommendations(description, type).catch(error => {
                        console.error('Error updating smart recommendations:', error);
                    });
                });
            }
            
            // ä¿å­˜äº¤æ˜“
            const saveTransactionBtn = document.getElementById('saveTransactionBtn');
            if (saveTransactionBtn) {
                saveTransactionBtn.addEventListener('click', () => {
                    this.saveTransaction();
                });
            }
            
            // å¯¼å‡ºç»Ÿè®¡æŒ‰é’®
            const exportStatsBtn = document.getElementById('exportStatsBtn');
            if (exportStatsBtn) {
                exportStatsBtn.addEventListener('click', () => {
                    this.showModal('exportModal');
                });
            }
            
            // ç¡®ä¿è®°è´¦æŒ‰é’®åŠŸèƒ½å¯ç”¨ï¼ˆå¤‡ç”¨é€»è¾‘ï¼‰
            if (!window.addTransactionBtnInitialized) {
                window.addTransactionBtnInitialized = true;
                // å¦‚æœéœ€è¦å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¤‡ç”¨é€»è¾‘
            }
            
            // äº¤æ˜“æœç´¢
            const transactionSearchInput = document.getElementById('transactionSearchInput');
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            const filterByDateBtn = document.getElementById('filterByDateBtn');
            
            if (transactionSearchInput) {
                transactionSearchInput.addEventListener('input', () => {
                    this.filterTransactions(
                        transactionSearchInput.value,
                        startDateInput?.value || '',
                        endDateInput?.value || ''
                    );
                });
            }
            
            // æ—¥æœŸç­›é€‰æŒ‰é’®
            if (filterByDateBtn) {
                filterByDateBtn.addEventListener('click', () => {
                    this.filterTransactions(
                        transactionSearchInput?.value || '',
                        startDateInput?.value || '',
                        endDateInput?.value || ''
                    );
                });
            }
            
            // æ—¥æœŸè¾“å…¥å˜åŒ–æ—¶è‡ªåŠ¨ç­›é€‰
            if (startDateInput) {
                startDateInput.addEventListener('change', () => {
                    this.filterTransactions(
                        transactionSearchInput?.value || '',
                        startDateInput.value,
                        endDateInput?.value || ''
                    );
                });
            }
            
            if (endDateInput) {
                endDateInput.addEventListener('change', () => {
                    this.filterTransactions(
                        transactionSearchInput?.value || '',
                        startDateInput?.value || '',
                        endDateInput.value
                    );
                });
            }
            
            // ä¿å­˜é¢„ç®—
            const saveBudgetBtn = document.getElementById('saveBudgetBtn');
            if (saveBudgetBtn) {
                saveBudgetBtn.addEventListener('click', () => {
                    this.saveBudget();
                });
            }
            
            // ç¡®è®¤å¯¼å‡º
            const confirmExportBtn = document.getElementById('confirmExportBtn');
            if (confirmExportBtn) {
                confirmExportBtn.addEventListener('click', () => {
                    this.exportData();
                });
            }
            
            // å…³é—­æ¨¡æ€æ¡†
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.hideModal();
                });
            });
            
            // åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†æŒ‰é’®
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            if (cancelDeleteBtn) {
                cancelDeleteBtn.addEventListener('click', () => {
                    this.hideModal('confirmDeleteModal');
                });
            }
            
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', async () => {
                    if (this.pendingDeleteTransactionId) {
                        try {
                            await DataStorage.deleteTransaction(this.pendingDeleteTransactionId);
                            this.showToast('äº¤æ˜“è®°å½•å·²åˆ é™¤', 'success');
                            await this.renderRecentTransactions();
                            this.hideModal('confirmDeleteModal');
                            this.pendingDeleteTransactionId = null;
                        } catch (error) {
                            console.error('åˆ é™¤äº¤æ˜“è®°å½•å¤±è´¥:', error);
                            this.showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        }
                    }
                });
            }
            
            // æ—¶é—´èŒƒå›´é€‰æ‹©
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.time-range-btn').forEach(b => {
                        b.classList.remove('bg-white', 'shadow-sm');
                    });
                    btn.classList.add('bg-white', 'shadow-sm');
                    
                    this.updateStatistics(btn.dataset.range);
                });
            });
            
            // åˆ†å¸ƒå›¾è¡¨ç±»å‹åˆ‡æ¢
            const expenseDistributionBtn = document.getElementById('expenseDistributionBtn');
            const incomeDistributionBtn = document.getElementById('incomeDistributionBtn');
            
            if (expenseDistributionBtn) {
                expenseDistributionBtn.addEventListener('click', () => {
                    expenseDistributionBtn.classList.remove('bg-gray-100', 'text-gray-600');
                    expenseDistributionBtn.classList.add('bg-expense', 'bg-opacity-10', 'text-expense');
                    if (incomeDistributionBtn) {
                        incomeDistributionBtn.classList.remove('bg-income', 'bg-opacity-10', 'text-income');
                        incomeDistributionBtn.classList.add('bg-gray-100', 'text-gray-600');
                    }
                    this.updateDistributionChart('expense');
                });
            }
            
            if (incomeDistributionBtn) {
                incomeDistributionBtn.addEventListener('click', () => {
                    incomeDistributionBtn.classList.remove('bg-gray-100', 'text-gray-600');
                    incomeDistributionBtn.classList.add('bg-income', 'bg-opacity-10', 'text-income');
                    if (expenseDistributionBtn) {
                        expenseDistributionBtn.classList.remove('bg-expense', 'bg-opacity-10', 'text-expense');
                        expenseDistributionBtn.classList.add('bg-gray-100', 'text-gray-600');
                    }
                    this.updateDistributionChart('income');
                });
            }
            
            // å¯¼å‡ºèŒƒå›´é€‰æ‹©
            document.querySelectorAll('input[name="exportRange"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const customDateRange = document.getElementById('customDateRange');
                    if (customDateRange) {
                        if (radio.value === 'custom') {
                            customDateRange.classList.remove('hidden');
                        } else {
                            customDateRange.classList.add('hidden');
                        }
                    }
                });
            });
        }

        static hideModal() {
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.classList.add('hidden');
                modalContainer.querySelectorAll('div[id$="Modal"]').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }
        }

        static showToast(message, type = 'info') {
            // åˆ›å»ºç®€å•çš„æç¤ºæ¡†
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }

        static async renderAllTransactions(searchTerm = '', startDate = '', endDate = '') {
            try {
                var transactions = await DataStorage.getTransactions() || [];
                var container = document.getElementById('allTransactionsList');
                
                if (!container) {
                    return;
                }
                
                // æŒ‰æ—¥æœŸé™åºæ’åº
                var sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // è¿‡æ»¤äº¤æ˜“
            var filteredTransactions = sortedTransactions.filter(t => {
                // æœç´¢è¯è¿‡æ»¤
                if (searchTerm) {
                    var isIncome = t.type === 'income';
                    var categories = isIncome ? incomeCategories : expenseCategories;
                    var category = categories.find(c => c.id === t.category) || { name: 'æœªçŸ¥' };
                    
                    const matchesSearch = category.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                         (t.description && t.description.toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    if (!matchesSearch) return false;
                }
                
                // æ—¥æœŸèŒƒå›´è¿‡æ»¤
                if (startDate || endDate) {
                    const transactionDate = new Date(t.date);
                    
                    if (startDate) {
                        const start = new Date(startDate);
                        if (transactionDate < start) return false;
                    }
                    
                    if (endDate) {
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999); // è®¾ç½®ä¸ºå½“å¤©ç»“æŸæ—¶é—´
                        if (transactionDate > end) return false;
                    }
                }
                
                return true;
            });
            
            if (filteredTransactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        ${searchTerm ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„äº¤æ˜“è®°å½•' : 'æš‚æ— äº¤æ˜“è®°å½•'}
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            filteredTransactions.forEach(transaction => {
                var isIncome = transaction.type === 'income';
                var categories = isIncome ? incomeCategories : expenseCategories;
                var category = categories.find(c => c.id === transaction.category) || { name: 'æœªçŸ¥', icon: 'fa-question', color: '#999' };
                
                var item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3';
                item.innerHTML = `
                    <div class="flex items-center flex-1">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3" style="background-color: ${category.color}20; color: ${category.color}">
                            <i class="fa ${category.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium">${category.name}</div>
                            <div class="text-xs text-gray-500">${formatDate(transaction.date)}</div>
                        </div>
                    </div>
                    <div class="text-right mr-4">
                        <div class="font-bold ${isIncome ? 'text-income' : 'text-expense'}">${isIncome ? '+' : '-'}${formatCurrency(transaction.amount)}</div>
                        ${transaction.description ? `<div class="text-xs text-gray-500">${transaction.description}</div>` : ''}
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-primary hover:text-primary/80 transition-colors edit-transaction-btn" data-id="${transaction.id}">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="text-expense hover:text-expense/80 transition-colors delete-transaction-btn" data-id="${transaction.id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(item);
                
                // ç»‘å®šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶
                const editBtn = item.querySelector('.edit-transaction-btn');
                const deleteBtn = item.querySelector('.delete-transaction-btn');
                
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        UIController.editTransaction(transaction);
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        UIController.deleteTransaction(transaction.id);
                    });
                }
            });
            } catch (error) {
                console.error('Error rendering transactions:', error);
                var container = document.getElementById('allTransactionsList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            åŠ è½½äº¤æ˜“è®°å½•æ—¶å‡ºé”™
                        </div>
                    `;
                }
            }
        }

        static async filterTransactions(searchTerm = '', startDate = '', endDate = '') {
            try {
                await this.renderAllTransactions(searchTerm, startDate, endDate);
            } catch (error) {
                console.error('Error filtering transactions:', error);
            }
        }

        static async renderBudgetHistory() {
            try {
                var budgets = await DataStorage.getBudgets() || [];
                var container = document.getElementById('budgetHistoryList');
                
                if (!container) {
                    return;
                }
                
                // æŒ‰æœˆä»½é™åºæ’åº
                var sortedBudgets = [...budgets].sort((a, b) => b.month.localeCompare(a.month));
                
                if (sortedBudgets.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            æš‚æ— é¢„ç®—è®°å½•
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                sortedBudgets.forEach(budget => {
                    var [year, month] = budget.month.split('-');
                    var monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
                    
                    var item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-3 border border-gray-100 rounded-lg';
                    item.innerHTML = `
                        <div>
                            <div class="font-medium">${year}å¹´${monthNames[parseInt(month) - 1]}</div>
                            <div class="text-xs text-gray-500">è®¾ç½®äº ${formatDate(budget.createdAt)}</div>
                        </div>
                        <div class="font-bold">${formatCurrency(budget.amount)}</div>
                    `;
                    
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error rendering budget history:', error);
                var container = document.getElementById('budgetHistoryList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            åŠ è½½é¢„ç®—è®°å½•æ—¶å‡ºé”™
                        </div>
                    `;
                }
            }
        }

        // ç¬”è®°ç›¸å…³æ–¹æ³•
        static renderNotes() {
            // æš‚æ—¶ä½¿ç”¨åŒæ­¥æ–¹æ³•ï¼Œé¿å…è¯­æ³•é”™è¯¯
            const notes = DataStorage.getNotes() || [];
            const container = document.getElementById('notesList');
            if (!container) return;

            if (notes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        æš‚æ— ç¬”è®°ï¼Œç‚¹å‡»"æ–°å»ºç¬”è®°"å¼€å§‹è®°å½•
                    </div>
                `;
                return;
            }

            // æŒ‰æ›´æ–°æ—¶é—´å€’åºæ’åˆ—
            const sortedNotes = notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            container.innerHTML = sortedNotes.map(note => `
                <div class="bg-dark-200/30 border border-white/5 rounded-lg p-4 card-hover cursor-pointer" data-note-id="${note.id}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800 text-lg">${note.title || 'æ— æ ‡é¢˜'}</h3>
                        <span class="text-xs text-gray-500">${this.formatDate(note.updatedAt)}</span>
                    </div>
                    <p class="text-gray-600 line-clamp-3 mb-3">${note.content || 'æ— å†…å®¹'}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">åˆ›å»ºäº ${this.formatDate(note.createdAt)}</span>
                        <div class="flex space-x-2">
                            <button class="edit-note-btn text-primary hover:text-primary/80" data-note-id="${note.id}">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-note-btn text-red-500 hover:text-red-600" data-note-id="${note.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // ç»‘å®šç¬”è®°å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('[data-note-id]').forEach(card => {
                card.addEventListener('click', (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯ç¼–è¾‘æˆ–åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘å¡ç‰‡ç‚¹å‡»
                    if (e.target.closest('.edit-note-btn') || e.target.closest('.delete-note-btn')) {
                        return;
                    }
                    const noteId = card.dataset.noteId;
                    this.editNote(noteId);
                });
            });

            // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
            container.querySelectorAll('.edit-note-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const noteId = btn.dataset.noteId;
                    this.editNote(noteId);
                });
            });

            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            container.querySelectorAll('.delete-note-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const noteId = btn.dataset.noteId;
                    this.deleteNote(noteId);
                });
            });
        }

        static async editNote(noteId) {
            try {
                const notes = await DataStorage.getNotes() || [];
                const note = notes.find(n => n.id === noteId);
                
                if (note) {
                    document.getElementById('notesModalTitle').textContent = 'ç¼–è¾‘ç¬”è®°';
                    document.getElementById('noteTitleInput').value = note.title || '';
                    document.getElementById('noteContentInput').value = note.content || '';
                    document.getElementById('deleteNoteBtn').classList.remove('hidden');
                    document.getElementById('deleteNoteBtn').dataset.noteId = noteId;
                    this.showModal('notesModal');
                }
            } catch (error) {
                console.error('Error editing note:', error);
                this.showToast('åŠ è½½ç¬”è®°å¤±è´¥', 'error');
            }
        }

        static async deleteNote(noteId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                try {
                    await DataStorage.deleteNote(noteId);
                    await this.renderNotes();
                    this.showToast('ç¬”è®°å·²åˆ é™¤', 'success');
                } catch (error) {
                    console.error('Error deleting note:', error);
                    this.showToast('åˆ é™¤ç¬”è®°å¤±è´¥', 'error');
                }
            }
        }

        static formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        static setTransactionType(type) {
            var incomeBtn = document.getElementById('incomeTypeBtn');
            var expenseBtn = document.getElementById('expenseTypeBtn');
            var incomeCategories = document.getElementById('incomeCategories');
            var expenseCategories = document.getElementById('expenseCategories');
            
            if (type === 'income') {
                incomeBtn.classList.add('bg-white', 'shadow-sm');
                expenseBtn.classList.remove('bg-white', 'shadow-sm');
                incomeCategories.classList.remove('hidden');
                expenseCategories.classList.add('hidden');
            } else {
                expenseBtn.classList.add('bg-white', 'shadow-sm');
                incomeBtn.classList.remove('bg-white', 'shadow-sm');
                expenseCategories.classList.remove('hidden');
                incomeCategories.classList.add('hidden');
            }
            
            // æ¸…é™¤ä¹‹å‰é€‰æ‹©çš„åˆ†ç±»
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ›´æ–°æ™ºèƒ½æ¨è
            var description = document.getElementById('descriptionInput').value;
            this.updateSmartRecommendations(description, type).catch(error => {
                console.error('Error updating smart recommendations:', error);
            });
        }

        static renderCategories() {
            var expenseContainer = document.getElementById('expenseCategories');
            var incomeContainer = document.getElementById('incomeCategories');
            
            // æ¸²æŸ“æ”¯å‡ºåˆ†ç±»
            expenseCategories.forEach(category => {
                var item = document.createElement('div');
                item.className = 'category-item flex flex-col items-center cursor-pointer';
                item.dataset.category = category.id;
                item.innerHTML = `
                    <div class="w-14 h-14 rounded-full flex items-center justify-center mb-1" style="background-color: ${category.color}20; color: ${category.color}">
                        <i class="fa ${category.icon} text-2xl"></i>
                    </div>
                    <span class="text-xs">${category.name}</span>
                `;
                
                item.addEventListener('click', () => {
                    document.querySelectorAll('#expenseCategories .category-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    item.classList.add('active');
                });
                
                expenseContainer.appendChild(item);
            });
            
            // æ¸²æŸ“æ”¶å…¥åˆ†ç±»
            incomeCategories.forEach(category => {
                var item = document.createElement('div');
                item.className = 'category-item flex flex-col items-center cursor-pointer';
                item.dataset.category = category.id;
                item.innerHTML = `
                    <div class="w-14 h-14 rounded-full flex items-center justify-center mb-1" style="background-color: ${category.color}20; color: ${category.color}">
                        <i class="fa ${category.icon} text-2xl"></i>
                    </div>
                    <span class="text-xs">${category.name}</span>
                `;
                
                item.addEventListener('click', () => {
                    document.querySelectorAll('#incomeCategories .category-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    item.classList.add('active');
                });
                
                incomeContainer.appendChild(item);
            });
        }

        static renderCalendar() {
            var now = new Date();
            this.currentCalendarYear = this.currentCalendarYear || now.getFullYear();
            this.currentCalendarMonth = this.currentCalendarMonth !== undefined ? this.currentCalendarMonth : now.getMonth();
            
            var firstDay = new Date(this.currentCalendarYear, this.currentCalendarMonth, 1);
            var lastDay = new Date(this.currentCalendarYear, this.currentCalendarMonth + 1, 0);
            var daysInMonth = lastDay.getDate();
            var startingDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // æ›´æ–°æœˆä»½æ ‡é¢˜
            document.getElementById('calendarMonthYear').textContent = `${this.currentCalendarYear}å¹´${this.currentCalendarMonth + 1}æœˆ`;
            
            // æ¸…ç©ºæ—¥å†
            var calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // æ·»åŠ ç©ºç™½æ ¼å­ï¼ˆä¸Šä¸ªæœˆçš„æ—¥æœŸï¼‰
            for (let i = 0; i < startingDayOfWeek; i++) {
                var dayElement = document.createElement('div');
                dayElement.className = 'calendar-day text-gray-300';
                calendarDays.appendChild(dayElement);
            }
            
            // æ·»åŠ å½“æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                var dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
                var isToday = now.getDate() === day && 
                                now.getMonth() === this.currentCalendarMonth && 
                                now.getFullYear() === this.currentCalendarYear;
                
                if (isToday) {
                    dayElement.classList.add('font-bold', 'text-primary');
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                dayElement.addEventListener('click', () => {
                    var selectedDate = new Date(this.currentCalendarYear, this.currentCalendarMonth, day);
                    document.getElementById('selectedDateText').textContent = formatDate(selectedDate);
                    document.getElementById('calendarContainer').classList.add('hidden');
                    
                    // ç§»é™¤å…¶ä»–æ—¥æœŸçš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.calendar-day').forEach(d => {
                        d.classList.remove('active');
                    });
                    
                    // æ·»åŠ å½“å‰æ—¥æœŸçš„é€‰ä¸­çŠ¶æ€
                    dayElement.classList.add('active');
                });
                
                calendarDays.appendChild(dayElement);
            }
            
            // è¡¥é½å‰©ä½™çš„ç©ºç™½æ ¼å­
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    var dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day text-gray-300';
                    calendarDays.appendChild(dayElement);
                }
            }
        }

        static async updateSmartRecommendations(description, type) {
            var container = document.getElementById('smartRecommendation');
            var recommendedCategoriesContainer = document.getElementById('recommendedCategories');
            
            if (!container || !recommendedCategoriesContainer) {
                return;
            }
            
            try {
                // è·å–æ¨èï¼ˆç­‰å¾…å¼‚æ­¥ç»“æœï¼‰
                var recommendations = await SmartCategoryRecommender.getRecommendations(description, type) || [];
                
                if (recommendations.length === 0) {
                    container.classList.add('hidden');
                    return;
                }
                
                // æ¸…ç©ºä¹‹å‰çš„æ¨è
                recommendedCategoriesContainer.innerHTML = '';
                
                // æ·»åŠ æ–°çš„æ¨è
                recommendations.forEach(recommendation => {
                    var item = document.createElement('div');
                    item.className = 'px-3 py-1 rounded-full text-sm font-medium cursor-pointer';
                    item.style.backgroundColor = `${recommendation.color}20`;
                    item.style.color = recommendation.color;
                    item.textContent = recommendation.name;
                    
                    // ç‚¹å‡»é€‰æ‹©åˆ†ç±»
                    item.addEventListener('click', () => {
                        // æ‰¾åˆ°å¯¹åº”çš„åˆ†ç±»é¡¹å¹¶ç‚¹å‡»
                        var categoryItem = document.querySelector(`.category-item[data-category="${recommendation.id}"]`);
                        if (categoryItem) {
                            categoryItem.click();
                        }
                    });
                    
                    recommendedCategoriesContainer.appendChild(item);
                });
                
                container.classList.remove('hidden');
            } catch (error) {
                console.error('Error updating smart recommendations:', error);
                container.classList.add('hidden');
            }
        }

        static async saveTransaction() {
            try {
                // è·å–è¡¨å•æ•°æ®
                const incomeTypeBtn = document.getElementById('incomeTypeBtn');
                const expenseTypeBtn = document.getElementById('expenseTypeBtn');
                const amountInput = document.getElementById('amountInput');
                const descriptionInput = document.getElementById('descriptionInput');
                const selectedDateText = document.getElementById('selectedDateText');
                
                if (!incomeTypeBtn || !expenseTypeBtn || !amountInput || !descriptionInput || !selectedDateText) {
                    throw new Error('è¡¨å•å…ƒç´ ä¸å®Œæ•´');
                }
                
                var isIncome = incomeTypeBtn.classList.contains('bg-white');
                var type = isIncome ? 'income' : 'expense';
                var amount = parseFloat(amountInput.value);
                var description = descriptionInput.value.trim();
                var dateText = selectedDateText.textContent;
                
                // è§£æä¸­æ–‡æ—¥æœŸæ ¼å¼ï¼ˆä¾‹å¦‚ï¼š2023å¹´1æœˆ1æ—¥ï¼‰
                var parseChineseDate = (dateStr) => {
                    var match = dateStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                    if (match) {
                        var [, year, month, day] = match;
                        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    }
                    return new Date(); // å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›å½“å‰æ—¥æœŸ
                };
                
                var date = parseChineseDate(dateText);
                
                // è·å–é€‰ä¸­çš„åˆ†ç±»
                var activeCategory = document.querySelector(`#${isIncome ? 'income' : 'expense'}Categories .category-item.active`);
                var category = activeCategory ? activeCategory.dataset.category : null;
                
                // éªŒè¯è¡¨å•
                if (!amount || amount <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                    return;
                }
                
                if (!category) {
                    alert('è¯·é€‰æ‹©åˆ†ç±»');
                    return;
                }
                
                // åˆ›å»ºäº¤æ˜“å¯¹è±¡
                var transaction = {
                    id: this.isEditingTransaction ? this.currentEditingTransactionId : generateId(),
                    type,
                    amount,
                    category,
                    date: date.toISOString(),
                    description,
                    created_at: new Date().toISOString()
                };
                
                // ä¿å­˜äº¤æ˜“
                if (this.isEditingTransaction) {
                    await DataStorage.updateTransaction(this.currentEditingTransactionId, transaction);
                    this.showToast('äº¤æ˜“è®°å½•å·²æ›´æ–°', 'success');
                } else {
                    await DataStorage.addTransaction(transaction);
                    this.showToast('äº¤æ˜“è®°å½•å·²ä¿å­˜', 'success');
                }
                
                // é‡ç½®è¡¨å•
                amountInput.value = '';
                descriptionInput.value = '';
                selectedDateText.textContent = formatDate(new Date());
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const smartRecommendation = document.getElementById('smartRecommendation');
                if (smartRecommendation) {
                    smartRecommendation.classList.add('hidden');
                }
                
                // éšè—æ¨¡æ€æ¡†
                this.hideModal();
                
                // ç«‹å³æ›´æ–°ä»ªè¡¨ç›˜ï¼Œç¡®ä¿æ•°æ®å®æ—¶æ˜¾ç¤º
                await this.renderDashboard();
                await this.renderRecentTransactions();
                
                // é‡ç½®ç¼–è¾‘çŠ¶æ€
                this.isEditingTransaction = false;
                this.currentEditingTransactionId = null;
            } catch (error) {
                console.error('ä¿å­˜äº¤æ˜“å¤±è´¥:', error);
                this.showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        static async renderDashboard() {
            var now = new Date();
            var monthlyStats = await StatisticsAnalyzer.getMonthlyStats(now);
            
            // æ›´æ–°æœˆåº¦æ”¶æ”¯
            const monthlyIncomeEl = document.getElementById('monthlyIncome');
            const monthlyExpenseEl = document.getElementById('monthlyExpense');
            const monthlyBalanceEl = document.getElementById('monthlyBalance');
            
            if (monthlyIncomeEl) monthlyIncomeEl.textContent = formatCurrency(monthlyStats.income);
            if (monthlyExpenseEl) monthlyExpenseEl.textContent = formatCurrency(monthlyStats.expense);
            if (monthlyBalanceEl) monthlyBalanceEl.textContent = formatCurrency(monthlyStats.balance);
            
            // æ›´æ–°é¢„ç®—è¿›åº¦
            await this.updateBudgetProgress();
            
            // æ›´æ–°æœ€è¿‘äº¤æ˜“
            this.renderRecentTransactions();
        }

        static async updateBudgetProgress() {
            var now = new Date();
            var currentMonth = now.toISOString().substr(0, 7);
            var budget = await DataStorage.getBudgetForMonth(currentMonth);
            var monthlyStats = await StatisticsAnalyzer.getMonthlyStats(now);
            
            if (budget) {
                var percentage = (monthlyStats.expense / budget.amount) * 100;
                var daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                var daysPassed = now.getDate();
                var daysLeft = daysInMonth - daysPassed;
                
                document.getElementById('budgetUsedText').textContent = `${formatCurrency(monthlyStats.expense)} / ${formatCurrency(budget.amount)}`;
                document.getElementById('budgetProgressBar').style.width = `${Math.min(percentage, 100)}%`;
                document.getElementById('budgetPercentage').textContent = `${Math.round(percentage)}%`;
                document.getElementById('budgetDaysLeft').textContent = `å‰©ä½™ ${daysLeft} å¤©`;
                
                // å¦‚æœè¶…å‡ºé¢„ç®—ï¼Œè¿›åº¦æ¡å˜çº¢
                if (percentage > 100) {
                    document.getElementById('budgetProgressBar').classList.remove('bg-primary');
                    document.getElementById('budgetProgressBar').classList.add('bg-expense');
                } else {
                    document.getElementById('budgetProgressBar').classList.remove('bg-expense');
                    document.getElementById('budgetProgressBar').classList.add('bg-primary');
                }
            } else {
                document.getElementById('budgetUsedText').textContent = `${formatCurrency(monthlyStats.expense)} / Â¥0`;
                document.getElementById('budgetProgressBar').style.width = '0%';
                document.getElementById('budgetPercentage').textContent = '0%';
                document.getElementById('budgetDaysLeft').textContent = 'æœªè®¾ç½®é¢„ç®—';
            }
        }

        static async renderRecentTransactions() {
            try {
            var transactions = await DataStorage.getTransactions() || [];
            var container = document.getElementById('recentTransactionsList');
            
            // æŒ‰æ—¥æœŸé™åºæ’åº
            var sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // å–æœ€è¿‘5æ¡
            var recentTransactions = sortedTransactions.slice(0, 5);
            
            if (recentTransactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        æš‚æ— äº¤æ˜“è®°å½•
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            recentTransactions.forEach(transaction => {
                var isIncome = transaction.type === 'income';
                var categories = isIncome ? incomeCategories : expenseCategories;
                var category = categories.find(c => c.id === transaction.category) || { name: 'æœªçŸ¥', icon: 'fa-question', color: '#999' };
                
                var item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3';
                item.innerHTML = `
                    <div class="flex items-center flex-1">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3" style="background-color: ${category.color}20; color: ${category.color}">
                            <i class="fa ${category.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium">${category.name}</div>
                            <div class="text-xs text-gray-500">${formatDate(transaction.date)}</div>
                        </div>
                    </div>
                    <div class="text-right mr-4">
                        <div class="font-bold ${isIncome ? 'text-income' : 'text-expense'}">${isIncome ? '+' : '-'}${formatCurrency(transaction.amount)}</div>
                        ${transaction.description ? `<div class="text-xs text-gray-500">${transaction.description}</div>` : ''}
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-primary hover:text-primary/80 transition-colors edit-transaction-btn" data-id="${transaction.id}">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="text-expense hover:text-expense/80 transition-colors delete-transaction-btn" data-id="${transaction.id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(item);
                
                // ç»‘å®šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶
                const editBtn = item.querySelector('.edit-transaction-btn');
                const deleteBtn = item.querySelector('.delete-transaction-btn');
                
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        UIController.editTransaction(transaction);
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        UIController.deleteTransaction(transaction.id);
                    });
                }
            });
            } catch (error) {
                console.error('Error rendering transactions:', error);
                var container = document.getElementById('recentTransactionsList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            åŠ è½½äº¤æ˜“è®°å½•æ—¶å‡ºé”™
                        </div>
                    `;
                }
            }
        }

        static editTransaction(transaction) {
            // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
            this.isEditingTransaction = true;
            this.currentEditingTransactionId = transaction.id;
            
            // æ˜¾ç¤ºæ·»åŠ äº¤æ˜“æ¨¡æ€æ¡†
            this.showModal('addTransactionModal');
            
            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            const modalTitle = document.querySelector('#addTransactionModal h3');
            if (modalTitle) {
                modalTitle.textContent = 'ç¼–è¾‘è®°å½•';
            }
            
            // è®¾ç½®äº¤æ˜“ç±»å‹
            this.setTransactionType(transaction.type);
            
            // å¡«å……é‡‘é¢
            const amountInput = document.getElementById('amountInput');
            if (amountInput) {
                amountInput.value = transaction.amount;
            }
            
            // é€‰æ‹©åˆ†ç±»
            const categoryButtons = document.querySelectorAll('#categoryContainer button');
            categoryButtons.forEach(btn => {
                btn.classList.remove('ring-2', 'ring-primary');
                if (btn.dataset.category === transaction.category) {
                    btn.classList.add('ring-2', 'ring-primary');
                }
            });
            
            // å¡«å……æè¿°
            const descriptionInput = document.getElementById('descriptionInput');
            if (descriptionInput) {
                descriptionInput.value = transaction.description || '';
            }
            
            // è®¾ç½®æ—¥æœŸ
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.value = transaction.date;
            }
        }

        static deleteTransaction(transactionId) {
            // å­˜å‚¨å¾…åˆ é™¤çš„äº¤æ˜“ID
            this.pendingDeleteTransactionId = transactionId;
            
            // æ˜¾ç¤ºç¡®è®¤åˆ é™¤æ¨¡æ€æ¡†
            this.showModal('confirmDeleteModal');
        }

        static async saveBudget() {
            var amount = parseFloat(document.getElementById('budgetAmountInput').value);
            var month = document.getElementById('budgetMonthInput').value;
            
            if (!amount || amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                return;
            }
            
            if (!month) {
                alert('è¯·é€‰æ‹©æœˆä»½');
                return;
            }
            
            var budget = {
                month,
                amount,
                created_at: new Date().toISOString()
            };
            
            try {
                await DataStorage.addBudget(budget);
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('modalContainer').classList.add('hidden');
                document.getElementById('budgetModal').classList.add('hidden');
                
                // æ›´æ–°ä»ªè¡¨ç›˜
                await this.renderDashboard();
                
                // æ›´æ–°é¢„ç®—å†å²
                await this.renderBudgetHistory();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                alert('é¢„ç®—å·²è®¾ç½®');
            } catch (error) {
                console.error('ä¿å­˜é¢„ç®—å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        static initCharts() {
            // åˆå§‹åŒ–è¶‹åŠ¿å›¾
            var trendCtx = document.getElementById('trendChart').getContext('2d');
            this.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'æ”¶å…¥',
                            data: [],
                            borderColor: '#52C41A',
                            backgroundColor: 'rgba(82, 196, 26, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'æ”¯å‡º',
                            data: [],
                            borderColor: '#FF4D4F',
                            backgroundColor: 'rgba(255, 77, 79, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // åˆå§‹åŒ–åˆ†å¸ƒå›¾
            var distributionCtx = document.getElementById('distributionChart').getContext('2d');
            this.distributionChart = new Chart(distributionCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.label || '';
                                    var value = context.parsed || 0;
                                    var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    var percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        static async updateStatistics(range) {
            // æ›´æ–°è¶‹åŠ¿å›¾
            var trendData = await StatisticsAnalyzer.getTrendData(range, 'expense');
            this.trendChart.data.labels = trendData.labels;
            this.trendChart.data.datasets[0].data = trendData.datasets[0].data;
            this.trendChart.data.datasets[1].data = trendData.datasets[1].data;
            this.trendChart.update();
            
            // æ›´æ–°åˆ†å¸ƒå›¾
            await this.updateDistributionChart('expense');
        }

        static async updateDistributionChart(type) {
            let transactions = [];
            var now = new Date();
            
            // æ ¹æ®å½“å‰é€‰ä¸­çš„æ—¶é—´èŒƒå›´è¿‡æ»¤äº¤æ˜“
            var activeRangeBtn = document.querySelector('.time-range-btn.bg-white');
            var range = activeRangeBtn ? activeRangeBtn.dataset.range : 'week';
            
            // è·å–æ‰€æœ‰äº¤æ˜“æ•°æ®
            var allTransactions = await DataStorage.getTransactions() || [];
            
            switch (range) {
                case 'week':
                    var weekRange = getWeekRange(now);
                    transactions = allTransactions.filter(t => {
                        var date = new Date(t.date);
                        return date >= weekRange.start && date <= weekRange.end && t.type === type;
                    });
                    break;
                case 'month':
                    var monthRange = getMonthRange(now);
                    transactions = allTransactions.filter(t => {
                        var date = new Date(t.date);
                        return date >= monthRange.start && date <= monthRange.end && t.type === type;
                    });
                    break;
                case 'year':
                    var yearRange = getYearRange(now);
                    transactions = allTransactions.filter(t => {
                        var date = new Date(t.date);
                        return date >= yearRange.start && date <= yearRange.end && t.type === type;
                    });
                    break;
                default:
                    transactions = allTransactions.filter(t => t.type === type);
            }
            
            // è·å–åˆ†ç±»ç»Ÿè®¡
            var categoryStats = StatisticsAnalyzer.getCategoryStats(transactions, type);
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            this.distributionChart.data.labels = categoryStats.map(c => c.name);
            this.distributionChart.data.datasets[0].data = categoryStats.map(c => c.amount);
            this.distributionChart.data.datasets[0].backgroundColor = categoryStats.map(c => c.color);
            this.distributionChart.update();
            
            // æ›´æ–°åˆ†ç±»æ˜ç»†
            this.renderCategoryDetails(categoryStats);
        }

        static renderCategoryDetails(categoryStats) {
            try {
            var container = document.getElementById('categoryDetails');
            
            if (categoryStats.length === 0 || categoryStats.every(c => c.amount === 0)) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        æš‚æ— æ•°æ®
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            categoryStats.forEach(stat => {
                if (stat.amount === 0) return;
                
                var item = document.createElement('div');
                item.className = 'mb-4';
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${stat.color}"></div>
                            <span class="font-medium">${stat.name}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold mr-2">${formatCurrency(stat.amount)}</span>
                            <span class="text-sm text-gray-500">${stat.percentage.toFixed(1)}%</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full" style="background-color: ${stat.color}; width: ${stat.percentage}%"></div>
                    </div>
                `;
                
                container.appendChild(item);
                
                // ç»‘å®šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶
                const editBtn = item.querySelector('.edit-transaction-btn');
                const deleteBtn = item.querySelector('.delete-transaction-btn');
                
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        UIController.editTransaction(transaction);
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        UIController.deleteTransaction(transaction.id);
                    });
                }
            });
            } catch (error) {
                console.error('Error rendering category details:', error);
                var container = document.getElementById('categoryDetails');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            åŠ è½½åˆ†ç±»è¯¦æƒ…æ—¶å‡ºé”™
                        </div>
                    `;
                }
            }
        }

        static async exportData() {
            try {
            var format = document.querySelector('input[name="exportFormat"]:checked').value;
            var range = document.querySelector('input[name="exportRange"]:checked').value;
            
            let transactions = await DataStorage.getTransactions() || [];
            
            // æ ¹æ®é€‰æ‹©çš„èŒƒå›´è¿‡æ»¤æ•°æ®
            if (range === 'currentMonth') {
                var now = new Date();
                var monthRange = getMonthRange(now);
                transactions = transactions.filter(t => {
                    var date = new Date(t.date);
                    return date >= monthRange.start && date <= monthRange.end;
                });
            } else if (range === 'custom') {
                var startDate = new Date(document.getElementById('exportStartDate').value);
                var endDate = new Date(document.getElementById('exportEndDate').value);
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¥æœŸèŒƒå›´');
                    return;
                }
                
                transactions = transactions.filter(t => {
                    var date = new Date(t.date);
                    return date >= startDate && date <= endDate;
                });
            }
            
            if (transactions.length === 0) {
                alert('æ‰€é€‰èŒƒå›´å†…æ²¡æœ‰æ•°æ®');
                return;
            }
            
            if (format === 'csv') {
                this.exportAsCSV(transactions);
            } else {
                this.exportAsJSON(transactions);
            }
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('modalContainer').classList.add('hidden');
            document.getElementById('exportModal').classList.add('hidden');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('å¯¼å‡ºæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        static exportAsJSON(transactions) {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            var dataStr = JSON.stringify(transactions, null, 2);
            var blob = new Blob([dataStr], { type: 'application/json;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `finance-tracker-${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        static exportAsCSV(transactions) {
            // æ·»åŠ è¡¨å¤´
            let csv = 'Type,Category,Amount,Date,Description\n';
            
            // æ·»åŠ æ•°æ®è¡Œ
            transactions.forEach(transaction => {
                var isIncome = transaction.type === 'income';
                var categories = isIncome ? incomeCategories : expenseCategories;
                var category = categories.find(c => c.id === transaction.category) || { name: 'æœªçŸ¥' };
                
                var type = isIncome ? 'æ”¶å…¥' : 'æ”¯å‡º';
                var date = new Date(transaction.date).toLocaleDateString('zh-CN');
                
                // è½¬ä¹‰CSVç‰¹æ®Šå­—ç¬¦
                var escapedDescription = transaction.description ? `"${transaction.description.replace(/"/g, '""')}"` : '';
                
                csv += `${type},${category.name},${transaction.amount},${date},${escapedDescription}\n`;
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `finance-tracker-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        static async showIncomeDetailModal() {
            this.showModal('incomeDetailModal');
            await this.renderIncomeDetail();
        }

        static async showExpenseDetailModal() {
            this.showModal('expenseDetailModal');
            await this.renderExpenseDetail();
        }

        static async renderIncomeDetail() {
            var now = new Date();
            var { start, end } = getMonthRange(now);
            
            // è·å–æœ¬æœˆæ”¶å…¥äº¤æ˜“
            var transactions = await DataStorage.getTransactions() || [];
            transactions = transactions.filter(t => {
                var date = new Date(t.date);
                return t.type === 'income' && date >= start && date <= end;
            });
            
            // æŒ‰æ—¥æœŸé™åºæ’åº
            var sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // æ¸²æŸ“æ”¶å…¥åˆ—è¡¨
            var listContainer = document.getElementById('incomeDetailList');
            listContainer.innerHTML = '';
            
            if (sortedTransactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        æœ¬æœˆæš‚æ— æ”¶å…¥è®°å½•
                    </div>
                `;
                return;
            }
            
            sortedTransactions.forEach(transaction => {
                var category = incomeCategories.find(c => c.id === transaction.category) || { name: 'æœªçŸ¥', icon: 'fa-question', color: '#999' };
                
                var item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3';
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3" style="background-color: ${category.color}20; color: ${category.color}">
                            <i class="fa ${category.icon}"></i>
                        </div>
                        <div>
                            <div class="font-medium">${category.name}</div>
                            <div class="text-xs text-gray-500">${formatDate(transaction.date)}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-income">+${formatCurrency(transaction.amount)}</div>
                        ${transaction.description ? `<div class="text-xs text-gray-500">${transaction.description}</div>` : ''}
                    </div>
                `;
                
                listContainer.appendChild(item);
            });
            
            // æ¸²æŸ“æ”¶å…¥åˆ†ç±»å›¾è¡¨
            this.renderIncomeCategoryChart(transactions);
        }

        static async renderExpenseDetail() {
            var now = new Date();
            var { start, end } = getMonthRange(now);
            
            // è·å–æœ¬æœˆæ”¯å‡ºäº¤æ˜“
            var transactions = await DataStorage.getTransactions() || [];
            transactions = transactions.filter(t => {
                var date = new Date(t.date);
                return t.type === 'expense' && date >= start && date <= end;
            });
            
            // æŒ‰æ—¥æœŸé™åºæ’åº
            var sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
            var listContainer = document.getElementById('expenseDetailList');
            listContainer.innerHTML = '';
            
            if (sortedTransactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        æœ¬æœˆæš‚æ— æ”¯å‡ºè®°å½•
                    </div>
                `;
                return;
            }
            
            sortedTransactions.forEach(transaction => {
                var category = expenseCategories.find(c => c.id === transaction.category) || { name: 'æœªçŸ¥', icon: 'fa-question', color: '#999' };
                
                var item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3';
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3" style="background-color: ${category.color}20; color: ${category.color}">
                            <i class="fa ${category.icon}"></i>
                        </div>
                        <div>
                            <div class="font-medium">${category.name}</div>
                            <div class="text-xs text-gray-500">${formatDate(transaction.date)}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-expense">-${formatCurrency(transaction.amount)}</div>
                        ${transaction.description ? `<div class="text-xs text-gray-500">${transaction.description}</div>` : ''}
                    </div>
                `;
                
                listContainer.appendChild(item);
            });
            
            // æ¸²æŸ“æ”¯å‡ºåˆ†ç±»å›¾è¡¨
            this.renderExpenseCategoryChart(transactions);
        }

        static renderIncomeCategoryChart(transactions) {
            // è·å–åˆ†ç±»ç»Ÿè®¡
            var categoryStats = StatisticsAnalyzer.getCategoryStats(transactions, 'income');
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            var labels = categoryStats.map(c => c.name);
            var data = categoryStats.map(c => c.amount);
            var backgroundColor = categoryStats.map(c => c.color);
            
            // è·å–æˆ–åˆ›å»ºå›¾è¡¨
            if (this.incomeCategoryChart) {
                this.incomeCategoryChart.destroy();
            }
            
            var ctx = document.getElementById('incomeCategoryChart').getContext('2d');
            this.incomeCategoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.label || '';
                                    var value = context.parsed || 0;
                                    var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    var percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        static renderExpenseCategoryChart(transactions) {
            // è·å–åˆ†ç±»ç»Ÿè®¡
            var categoryStats = StatisticsAnalyzer.getCategoryStats(transactions, 'expense');
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            var labels = categoryStats.map(c => c.name);
            var data = categoryStats.map(c => c.amount);
            var backgroundColor = categoryStats.map(c => c.color);
            
            // è·å–æˆ–åˆ›å»ºå›¾è¡¨
            if (this.expenseCategoryChart) {
                this.expenseCategoryChart.destroy();
            }
            
            var ctx = document.getElementById('expenseCategoryChart').getContext('2d');
            this.expenseCategoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.label || '';
                                    var value = context.parsed || 0;
                                    var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    var percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
    }



    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
    // æ£€æŸ¥ Supabase SDK æ˜¯å¦åŠ è½½
    function checkSupabaseSDK() {
        return new Promise((resolve) => {
            if (window.supabase && window.supabase.createClient) {
                console.log('Supabase SDK loaded successfully');
                resolve(true);
                return;
            }
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´åå†æ¬¡æ£€æŸ¥
            let attempts = 0;
            const maxAttempts = 5;
            const interval = setInterval(() => {
                attempts++;
                if (window.supabase && window.supabase.createClient) {
                    clearInterval(interval);
                    console.log('Supabase SDK loaded successfully after', attempts, 'attempts');
                    resolve(true);
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    console.error('Supabase SDK failed to load after', maxAttempts, 'attempts');
                    resolve(false);
                }
            }, 500);
        });
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
        // ç­‰å¾… Supabase SDK åŠ è½½
        const sdkLoaded = await checkSupabaseSDK();
        if (!sdkLoaded) {
            console.error('Supabase SDK not loaded. Some features may not work properly.');
            // æ˜¾ç¤ºé”™è¯¯æç¤ºç»™ç”¨æˆ·
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-0 left-0 right-0 bg-red-500 text-white text-center py-2 z-50';
            errorDiv.innerHTML = 'æ•°æ®æœåŠ¡è¿æ¥å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚';
            document.body.appendChild(errorDiv);
        }
        // å¯†ç éªŒè¯åŠŸèƒ½
        function initPasswordProtection() {
            const passwordModal = document.getElementById('passwordModal');
            const passwordInput = document.getElementById('passwordInput');
            const unlockBtn = document.getElementById('unlockBtn');
            const passwordError = document.getElementById('passwordError');
            
            // é»˜è®¤å¯†ç 
            const DEFAULT_PASSWORD = '888666';
            
            // ä½¿ç”¨é»˜è®¤å¯†ç ï¼Œå› ä¸ºapp_settingsè¡¨ä¸å­˜åœ¨
            const getStoredPassword = async () => {
                // ç”±äºapp_settingsè¡¨ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›é»˜è®¤å¯†ç 
                // è¿™æ ·å¯ä»¥ç¡®ä¿åº”ç”¨èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œè€Œä¸éœ€è¦é¢å¤–çš„æ•°æ®åº“è¡¨
                return DEFAULT_PASSWORD;
            };
            
            // éªŒè¯å¯†ç 
            const verifyPassword = async (inputPassword) => {
                const storedPassword = await getStoredPassword();
                return inputPassword === storedPassword;
            };
            
            // è§£é”åº”ç”¨
            const unlockApp = () => {
                passwordModal.classList.add('hidden');
                // ä¿å­˜è§£é”çŠ¶æ€åˆ°localStorageï¼Œæœ‰æ•ˆæœŸä¸ºå½“å‰ä¼šè¯
                localStorage.setItem('app_unlocked', 'true');
            };
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»è§£é”
            const isUnlocked = localStorage.getItem('app_unlocked') === 'true';
            if (!isUnlocked) {
                passwordModal.classList.remove('hidden');
            } else {
                passwordModal.classList.add('hidden');
            }
            
            // ç»‘å®šæ—ºå­—ç‚¹å‡»äº‹ä»¶
            const wangsymbol = document.getElementById('wangsymbol');
            if (wangsymbol) {
                wangsymbol.addEventListener('click', async () => {
                    const inputPassword = passwordInput.value.trim();
                    
                    if (!inputPassword) {
                        passwordError.textContent = 'è¯·è¾“å…¥å¯†ç ';
                        passwordError.classList.remove('hidden');
                        return;
                    }
                    
                    if (await verifyPassword(inputPassword)) {
                        passwordError.classList.add('hidden');
                        unlockApp();
                    } else {
                        passwordError.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                        passwordError.classList.remove('hidden');
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                });
            }
            
            // ç»‘å®šå›è½¦é”®äº‹ä»¶
            if (passwordInput) {
                passwordInput.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const inputPassword = passwordInput.value.trim();
                        
                        if (!inputPassword) {
                            passwordError.textContent = 'è¯·è¾“å…¥å¯†ç ';
                            passwordError.classList.remove('hidden');
                            return;
                        }
                        
                        if (await verifyPassword(inputPassword)) {
                            passwordError.classList.add('hidden');
                            unlockApp();
                        } else {
                            passwordError.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                            passwordError.classList.remove('hidden');
                            passwordInput.value = '';
                            passwordInput.focus();
                        }
                    }
                });
                
                // è‡ªåŠ¨èšç„¦åˆ°å¯†ç è¾“å…¥æ¡†
                passwordInput.focus();
            }
        }
        
        // åˆå§‹åŒ–å¯†ç ä¿æŠ¤
        initPasswordProtection();
        
        // åˆå§‹åŒ–UIæ§åˆ¶å™¨
        await UIController.init();
    });
</script>

</body></html>

